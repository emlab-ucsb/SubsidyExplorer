---
output:
  html_document: default

title: "Paper # 1 - Figures"
author: "Kat Millage"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 11pt
---

# Description

```{r setup, include=FALSE}
# Load packages
library(knitr) 
library(countrycode) # country name matching
library(sf)
library(rworldmap)
library(rmapshaper)
library(tidyverse)

# Path to cleaned subsidies data file
subsidy_dat_sumaila_path <- here::here("data", "edited", "sumaila_et_al_2019_subsidies_tidy.csv")

# Path to binned effort data file
effort_dat_binned_path <- here::here("results", "02-vessel-list", "effort_binned_good_fishing_vessels_2018_raw.csv")

# Path to upsides data file 
upsides_dat_path <- here::here("data", "edited", "costello_et_al_2016_upsides_tidy.csv")

# Chunk options
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F, prompt = F, error = F)

# Directories for the output files generated by this script
results_dir <- here::here("papers", "paper-1/")
if (dir.exists(results_dir) == F) {
  dir.create(results_dir, recursive = T)
}
```

```{r}
# Plot themes and shapefiles
map_theme <- theme(panel.background = element_rect(fill ="black"),
        plot.background = element_rect(fill = "black"),
        legend.background=element_rect(fill="black"),
        legend.text = element_text(color = "white", size = 16),
        legend.title = element_text(color = "white", size = 16),
        legend.title.align = 1,
        legend.direction="horizontal",
        legend.position = "bottom",
        legend.justification = "center",
        axis.text = element_text(color = "white", size = rel(1)),
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

plot_theme <- theme_bw()+
  theme(legend.text = element_text(color = "black", size = 16),
        legend.title = element_text(color = "black", size = 16),
        legend.title.align = 1,
        legend.direction = "horizontal",
        legend.position = "bottom",
        legend.justification = "center",
        axis.text = element_text(color = "black", size = rel(1)))

# Land shapefile
world_land <- st_as_sf(rworldmap::countriesLow) ## data(countriesLow) is from the rworldmap package

# FAO regions
fao_regions <- read_sf(here::here("data", "shapefiles", "fao"), layer = "World_Fao_Zones") %>%
  rename(fao_region = zone) %>%
  rmapshaper::ms_simplify(keep = 0.05)
```

# Version 1: Binned effort and median F/Fmsy by FAO region

```{r}
effort_binned_good_fishing_vessels_2018 <- read_csv(effort_dat_binned_path)
```

# Correct outdated flag codes and Identify EU and USA dependent vessels

Before allocating catches and subsidies across vessels, we need to identify vessels flagged to states that are overseas dependencies of the EU or USA. We assume that these vessels recieve subsidies from their sovereign states and therefore their fishing efforts should be included in the totals. 

```{r}
# Load country dependencies helper file
country_dependencies <- read_csv(here::here("data", "lookup-tables", "country_dependencies.csv"))

# Netherlands overseas territories
nld_territories <- country_dependencies$iso3[country_dependencies$is_overseas_territory & country_dependencies$sovereign_iso3 == "NLD"]

# France overseas territories
fra_territories <- country_dependencies$iso3[country_dependencies$is_overseas_territory & country_dependencies$sovereign_iso3 == "FRA"]

# Denmark overseas territories
dnk_territories <- country_dependencies$iso3[country_dependencies$is_overseas_territory & country_dependencies$sovereign_iso3 == "DNK"]

# British overseas territories
gbr_territories <- country_dependencies$iso3[country_dependencies$is_overseas_territory & country_dependencies$sovereign_iso3 == "GBR"]

# Norway overseas territories
nor_territories <- country_dependencies$iso3[country_dependencies$is_overseas_territory & country_dependencies$sovereign_iso3 == "NOR"]

# US overseas territories:  American Samoa, Guam, Northern Marianas Islands, Puerto Rico, US Virgin Islands
usa_territories <- country_dependencies$iso3[country_dependencies$is_overseas_territory & country_dependencies$sovereign_iso3 == "USA"]

# Australian overseas territories: Christmas Island
aus_territories <- country_dependencies$iso3[country_dependencies$is_overseas_territory & country_dependencies$sovereign_iso3 == "AUS"]
```

We apply these to our binned fishing effort

```{r}
effort_binned <- effort_binned_good_fishing_vessels_2018 %>%
  mutate(new_flag = case_when(flag %in% nld_territories ~ "NLD",
                              flag %in% fra_territories ~ "FRA",
                              flag %in% dnk_territories ~ "DNK",
                              flag %in% gbr_territories ~ "GBR",
                              flag %in% nor_territories ~ "NOR",
                              flag %in% usa_territories ~ "USA",
                              flag %in% aus_territories ~ "AUS",
                              flag == "COK" ~ "NZL", # for now assign cook islands to new zealand
                              TRUE ~ flag))

effort_binned$new_flag[effort_binned$new_flag == "GCA"] <- "GTM"
effort_binned$new_flag[effort_binned$new_flag == "ROM"] <- "ROU"
effort_binned$new_flag[effort_binned$new_flag == "UNK"] <- NA
```

### Subsidy intensities

Now lets get fishing effort totals by flag state

```{r}
effort_totals_flag <- effort_binned %>%
  group_by(new_flag) %>%
  summarize(fishing_KWh_lat_lon = sum(fishing_KWh_lat_lon, na.rm = T),
            fishing_hours_lat_lon = sum(fishing_hours_lat_lon, na.rm = T))
```

We then load our subsidy data, and calculate subsidy rates by flag for 2018. Subsidy rates are then applied to our binned effort data by flag. 

```{r}
subsidy_dat_sumaila <- read_csv(subsidy_dat_sumaila_path) %>%
  group_by(iso3, category) %>%
  summarize(subs = sum(value, na.rm = T)) %>%
  spread(category, subs) %>%
  rename(A_subs = A,
         B_subs = B,
         C_subs = C) %>%
  mutate(BC_subs = B_subs + C_subs,
         tot_subs = A_subs + B_subs + C_subs)
```

```{r}
# Calculate subsidy rates by flag
subsidy_rates_flag <- effort_totals_flag %>%
  left_join(subsidy_dat_sumaila, by = c("new_flag" = "iso3")) %>%
  mutate(A_subs_KWh = A_subs/fishing_KWh_lat_lon,
         B_subs_KWh = B_subs/fishing_KWh_lat_lon,
         C_subs_KWh = C_subs/fishing_KWh_lat_lon,
         BC_subs_KWh = BC_subs/fishing_KWh_lat_lon,
         tot_subs_KWh = tot_subs/fishing_KWh_lat_lon) %>%
  dplyr::select(new_flag, contains("subs_KWh"))

# Apply subsidy rates to binned effort
effort_binned_sub_intensity <- effort_binned %>%
  left_join(subsidy_rates_flag, by = "new_flag")

# Summarize by lat/lon
subsidy_intensity_binned <- effort_binned_sub_intensity %>%
  group_by(lat_bin_center, lon_bin_center) %>%
  summarize(med_B_subs_KWh = median(B_subs_KWh, na.rm = T),
            med_BC_subs_KWh = median(BC_subs_KWh, na.rm = T),
            med_tot_subs_KWh = median(tot_subs_KWh, na.rm = T),
            mean_B_subs_KWh = mean(B_subs_KWh, na.rm = T),
            mean_BC_subs_KWh = mean(BC_subs_KWh, na.rm = T),
            mean_tot_subs_KWh = mean(tot_subs_KWh, na.rm = T),
            w_mean_B_subs_KWh = weighted.mean(B_subs_KWh, w = fishing_KWh_lat_lon, na.rm = T),
            w_mean_BC_subs_KWh = weighted.mean(BC_subs_KWh, w = fishing_KWh_lat_lon, na.rm = T),
            w_mean_tot_subs_KWh = weighted.mean(tot_subs_KWh, w = fishing_KWh_lat_lon, na.rm = T),
            tot_fishing_KWh = sum(fishing_KWh_lat_lon, na.rm = T))

# Summarize by fao region
subsidy_intensity_region <- effort_binned_sub_intensity %>%
  group_by(fao_region) %>%
  summarize(med_B_subs_KWh = median(B_subs_KWh, na.rm = T),
            med_BC_subs_KWh = median(BC_subs_KWh, na.rm = T),
            med_tot_subs_KWh = median(tot_subs_KWh, na.rm = T),
            mean_B_subs_KWh = mean(B_subs_KWh, na.rm = T),
            mean_BC_subs_KWh = mean(BC_subs_KWh, na.rm = T),
            mean_tot_subs_KWh = mean(tot_subs_KWh, na.rm = T),
            w_mean_B_subs_KWh = weighted.mean(B_subs_KWh, w = fishing_KWh_lat_lon, na.rm = T),
            w_mean_BC_subs_KWh = weighted.mean(BC_subs_KWh, w = fishing_KWh_lat_lon, na.rm = T),
            w_mean_tot_subs_KWh = weighted.mean(tot_subs_KWh, w = fishing_KWh_lat_lon, na.rm = T),
            tot_fishing_KWh = sum(fishing_KWh_lat_lon, na.rm = T))
```

Now we go back to our effort data, and apply our subsidy rates. 

Now let's calculate and plot the median bad subsidy intensities by lat/lon bin and FAO region.

```{r}
median_breaks <- seq(0,8, by = 2)
median_limits <- c(0,8)
median_labels <- c("0", "2", "4", "6", paste0("\u2265","8"))

# Total subsidies
median_subsidy_intensity_tot_grid_map <- subsidy_intensity_binned %>%
  ggplot()+
  geom_tile(aes(x = lon_bin_center, y=lat_bin_center, fill = med_tot_subs_KWh)) +
  geom_sf(data=world_land, color = NA, fill="grey30") +
  #geom_sf(data=eez_boundaries, color="grey80", size=0.1, aes(group = mrgid_eez)) +
  scale_fill_viridis_c(name="Median Subsidy Intensity \n($/KWh)", 
                       na.value = "#000000", 
                       limits = median_limits, 
                       breaks = median_breaks,
                       labels = median_labels,
                       oob = scales::squish) +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), limits = c(-80,90))+
  xlab("") +
  ylab("") +
  map_theme + 
  guides(fill=guide_colorbar(
   title.position = "left",
   title.hjust = 0.5,
   frame.colour = "white",
   barwidth=4,
   barheight=0.25,
   default.unit="inch"))

median_subsidy_intensity_tot_grid_map

ggsave(paste0(results_dir, "median_subsidy_intensity_tot_grid_map.png"), dpi = 200, width = 7, height = 5)

# Bad subsidies only
median_subsidy_intensity_B_grid_map <- subsidy_intensity_binned %>%
  ggplot()+
  geom_tile(aes(x = lon_bin_center, y=lat_bin_center, fill = med_B_subs_KWh)) +
  geom_sf(data=world_land, color = NA, fill="grey30") +
  #geom_sf(data=eez_boundaries, color="grey80", size=0.1, aes(group = mrgid_eez)) +
  scale_fill_viridis_c(name="Median Subsidy Intensity \n($/KWh)", 
                       na.value = "#000000", 
                       limits = median_limits, 
                       breaks = median_breaks,
                       labels = median_labels,
                       oob = scales::squish) +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), limits = c(-80,90))+
  xlab("") +
  ylab("") +
  map_theme + 
  guides(fill=guide_colorbar(
   title.position = "left",
   title.hjust = 0.5,
   frame.colour = "white",
   barwidth=4,
   barheight=0.25,
   default.unit="inch"))

median_subsidy_intensity_B_grid_map

ggsave(paste0(results_dir, "median_subsidy_intensity_B_grid_map.png"), dpi = 200, width = 7, height = 5)

# Bad and ambiguous subsidies
median_subsidy_intensity_BC_grid_map <- subsidy_intensity_binned %>%
  ggplot()+
  geom_tile(aes(x = lon_bin_center, y=lat_bin_center, fill = med_BC_subs_KWh)) +
  geom_sf(data=world_land, color = NA, fill="grey30") +
  #geom_sf(data=eez_boundaries, color="grey80", size=0.1, aes(group = mrgid_eez)) +
  scale_fill_viridis_c(name="Median Subsidy Intensity \n($/KWh)", 
                       na.value = "#000000", 
                       limits = median_limits, 
                       breaks = median_breaks,
                       labels = median_labels,
                       oob = scales::squish) +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), limits = c(-80,90))+
  xlab("") +
  ylab("") +
  map_theme + 
  guides(fill=guide_colorbar(
   title.position = "left",
   title.hjust = 0.5,
   frame.colour = "white",
   barwidth=4,
   barheight=0.25,
   default.unit="inch"))

median_subsidy_intensity_BC_grid_map

ggsave(paste0(results_dir, "median_subsidy_intensity_BC_grid_map.png"), dpi = 200, width = 7, height = 5)

```

```{r}
region_median_breaks <- seq(0,2, by = 0.5)
region_median_limits <- c(0,2)
region_median_labels <- c("0", "0.5", "1", "1.5", paste0("\u2265","2"))

# Total subsidies
median_subsidy_intensity_tot_region_map <- subsidy_intensity_region %>%
  right_join(fao_regions, by = "fao_region") %>%
  ggplot()+
  geom_sf(aes(geometry = geometry, fill = med_tot_subs_KWh), color = "#000000") +
  geom_sf(data=world_land, color = NA, fill="grey30") +
  scale_fill_viridis_c(name="Median Subsidy Intensity \n($/KWh)", 
                       na.value = "#000000", 
                       limits = region_median_limits, 
                       breaks = region_median_breaks,
                       labels = region_median_labels,
                       oob = scales::squish) +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), limits = c(-80,90))+
  xlab("") +
  ylab("") +
  map_theme + 
  guides(fill=guide_colorbar(
   title.position = "left",
   title.hjust = 0.5,
   frame.colour = "white",
   barwidth=4,
   barheight=0.25,
   default.unit="inch"))

median_subsidy_intensity_tot_region_map

ggsave(paste0(results_dir, "median_subsidy_intensity_tot_region_map.png"), dpi = 200, width = 7, height = 5)

# Bad subsidies
median_subsidy_intensity_B_region_map <- subsidy_intensity_region %>%
  right_join(fao_regions, by = "fao_region") %>%
  ggplot()+
  geom_sf(aes(geometry = geometry, fill = med_B_subs_KWh), color = "#000000") +
  geom_sf(data=world_land, color = NA, fill="grey30") +
  scale_fill_viridis_c(name="Median Subsidy Intensity \n($/KWh)", 
                       na.value = "#000000", 
                       limits = region_median_limits, 
                       breaks = region_median_breaks,
                       labels = region_median_labels,
                       oob = scales::squish) +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), limits = c(-80,90))+
  xlab("") +
  ylab("") +
  map_theme + 
  guides(fill=guide_colorbar(
   title.position = "left",
   title.hjust = 0.5,
   frame.colour = "white",
   barwidth=4,
   barheight=0.25,
   default.unit="inch"))

median_subsidy_intensity_B_region_map

ggsave(paste0(results_dir, "median_subsidy_intensity_B_region_map.png"), dpi = 200, width = 7, height = 5)

# Ambiguous and Bad subsidies
median_subsidy_intensity_BC_region_map <- subsidy_intensity_region %>%
  right_join(fao_regions, by = "fao_region") %>%
  ggplot()+
  geom_sf(aes(geometry = geometry, fill = med_BC_subs_KWh), color = "#000000") +
  geom_sf(data=world_land, color = NA, fill="grey30") +
  scale_fill_viridis_c(name="Median Subsidy Intensity \n($/KWh)", 
                       na.value = "#000000", 
                       limits = region_median_limits, 
                       breaks = region_median_breaks,
                       labels = region_median_labels,
                       oob = scales::squish) +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), limits = c(-80,90))+
  xlab("") +
  ylab("") +
  map_theme + 
  guides(fill=guide_colorbar(
   title.position = "left",
   title.hjust = 0.5,
   frame.colour = "white",
   barwidth=4,
   barheight=0.25,
   default.unit="inch"))

median_subsidy_intensity_BC_region_map

ggsave(paste0(results_dir, "median_subsidy_intensity_BC_region_map.png"), dpi = 200, width = 7, height = 5)

```

Do means too. 

```{r}
mean_breaks <- seq(0,8, by = 2)
mean_limits <- c(0,8)
mean_labels <- c("0", "2", "4", "6", paste0("\u2265","8"))

# Total subsidies 
mean_subsidy_intensity_tot_grid_map <- subsidy_intensity_binned %>%
  ggplot()+
  geom_tile(aes(x = lon_bin_center, y=lat_bin_center, fill = mean_tot_subs_KWh)) +
  geom_sf(data=world_land, color = NA, fill="grey30") +
  #geom_sf(data=eez_boundaries, color="grey80", size=0.1, aes(group = mrgid_eez)) +
  scale_fill_viridis_c(name="Mean Subsidy Intensity \n($/KWh)", 
                     na.value = "#000000", 
                     limits = mean_limits, 
                     breaks = mean_breaks,
                     labels = mean_labels,
                     oob = scales::squish) +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), limits = c(-80,90))+
  xlab("") +
  ylab("") +
  map_theme + 
  guides(fill=guide_colorbar(
   title.position = "left",
   title.hjust = 0.5,
   frame.colour = "white",
   barwidth=4,
   barheight=0.25,
   default.unit="inch"))

mean_subsidy_intensity_tot_grid_map

ggsave(paste0(results_dir, "mean_subsidy_intensity_tot_grid_map.png"), dpi = 200, width = 7, height = 5)

# Bad subsidies 
mean_subsidy_intensity_B_grid_map <- subsidy_intensity_binned %>%
  ggplot()+
  geom_tile(aes(x = lon_bin_center, y=lat_bin_center, fill = mean_B_subs_KWh)) +
  geom_sf(data=world_land, color = NA, fill="grey30") +
  #geom_sf(data=eez_boundaries, color="grey80", size=0.1, aes(group = mrgid_eez)) +
  scale_fill_viridis_c(name="Mean Subsidy Intensity \n($/KWh)", 
                     na.value = "#000000", 
                     limits = mean_limits, 
                     breaks = mean_breaks,
                     labels = mean_labels,
                     oob = scales::squish) +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), limits = c(-80,90))+
  xlab("") +
  ylab("") +
  map_theme + 
  guides(fill=guide_colorbar(
   title.position = "left",
   title.hjust = 0.5,
   frame.colour = "white",
   barwidth=4,
   barheight=0.25,
   default.unit="inch"))

mean_subsidy_intensity_B_grid_map

ggsave(paste0(results_dir, "mean_subsidy_intensity_B_grid_map.png"), dpi = 200, width = 7, height = 5)

# Bad and ambiguous subsidies 
mean_subsidy_intensity_BC_grid_map <- subsidy_intensity_binned %>%
  ggplot()+
  geom_tile(aes(x = lon_bin_center, y=lat_bin_center, fill = mean_BC_subs_KWh)) +
  geom_sf(data=world_land, color = NA, fill="grey30") +
  #geom_sf(data=eez_boundaries, color="grey80", size=0.1, aes(group = mrgid_eez)) +
  scale_fill_viridis_c(name="Mean Subsidy Intensity \n($/KWh)", 
                     na.value = "#000000", 
                     limits = mean_limits, 
                     breaks = mean_breaks,
                     labels = mean_labels,
                     oob = scales::squish) +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), limits = c(-80,90))+
  xlab("") +
  ylab("") +
  map_theme + 
  guides(fill=guide_colorbar(
   title.position = "left",
   title.hjust = 0.5,
   frame.colour = "white",
   barwidth=4,
   barheight=0.25,
   default.unit="inch"))

mean_subsidy_intensity_BC_grid_map

ggsave(paste0(results_dir, "mean_subsidy_intensity_BC_grid_map.png"), dpi = 200, width = 7, height = 5)
```

```{r}
# Tot subs
mean_subsidy_intensity_tot_region_map <- subsidy_intensity_region %>%
  right_join(fao_regions, by = "fao_region") %>%
  ggplot()+
  geom_sf(aes(geometry = geometry, fill = mean_tot_subs_KWh)) +
  geom_sf(data=world_land, color = NA, fill="grey30") +
  scale_fill_viridis_c(name="Mean Subsidy Intensity \n($/KWh)", 
                       na.value = "#000000", 
                       limits = mean_limits, 
                       breaks = mean_breaks,
                       labels = mean_labels,
                       oob = scales::squish) +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), limits = c(-80,90))+
  xlab("") +
  ylab("") +
  map_theme + 
  guides(fill=guide_colorbar(
   title.position = "left",
   title.hjust = 0.5,
   frame.colour = "white",
   barwidth=4,
   barheight=0.25,
   default.unit="inch"))

mean_subsidy_intensity_tot_region_map

ggsave(paste0(results_dir, "mean_subsidy_intensity_tot_region_map.png"), dpi = 200, width = 7, height = 5)

# Bad subs
mean_subsidy_intensity_B_region_map <- subsidy_intensity_region %>%
  right_join(fao_regions, by = "fao_region") %>%
  ggplot()+
  geom_sf(aes(geometry = geometry, fill = mean_B_subs_KWh)) +
  geom_sf(data=world_land, color = NA, fill="grey30") +
  scale_fill_viridis_c(name="Mean Subsidy Intensity \n($/KWh)", 
                       na.value = "#000000", 
                       limits = mean_limits, 
                       breaks = mean_breaks,
                       labels = mean_labels,
                       oob = scales::squish) +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), limits = c(-80,90))+
  xlab("") +
  ylab("") +
  map_theme + 
  guides(fill=guide_colorbar(
   title.position = "left",
   title.hjust = 0.5,
   frame.colour = "white",
   barwidth=4,
   barheight=0.25,
   default.unit="inch"))

mean_subsidy_intensity_B_region_map

ggsave(paste0(results_dir, "mean_subsidy_intensity_B_region_map.png"), dpi = 200, width = 7, height = 5)

# Bad and ambiguous subs
mean_subsidy_intensity_BC_region_map <- subsidy_intensity_region %>%
  right_join(fao_regions, by = "fao_region") %>%
  ggplot()+
  geom_sf(aes(geometry = geometry, fill = mean_BC_subs_KWh)) +
  geom_sf(data=world_land, color = NA, fill="grey30") +
  scale_fill_viridis_c(name="Mean Subsidy Intensity \n($/KWh)", 
                       na.value = "#000000", 
                       limits = mean_limits, 
                       breaks = mean_breaks,
                       labels = mean_labels,
                       oob = scales::squish) +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), limits = c(-80,90))+
  xlab("") +
  ylab("") +
  map_theme + 
  guides(fill=guide_colorbar(
   title.position = "left",
   title.hjust = 0.5,
   frame.colour = "white",
   barwidth=4,
   barheight=0.25,
   default.unit="inch"))

mean_subsidy_intensity_BC_region_map

ggsave(paste0(results_dir, "mean_subsidy_intensity_BC_region_map.png"), dpi = 200, width = 7, height = 5)
```

Let's make ones for the weighted means too using fishing KWh as the weights. 

```{r}
weighted_mean_breaks <- seq(0,6, by = 1)
weighted_mean_limits <- c(0,6)
weighted_mean_labels <- c("0", "1", "2", "3", "4", "5", paste0("\u2265","6"))

# Tot subs
w_mean_subsidy_intensity_tot_grid_map <- subsidy_intensity_binned %>%
  ggplot()+
  geom_tile(aes(x = lon_bin_center, y=lat_bin_center, fill = w_mean_tot_subs_KWh)) +
  geom_sf(data=world_land, color = NA, fill="grey30") +
  #geom_sf(data=eez_boundaries, color="grey80", size=0.1, aes(group = mrgid_eez)) +
  scale_fill_viridis_c(name="Weighted Mean Subsidy Intensity \n($/KWh)", 
                       na.value = "#000000", 
                       limits = weighted_mean_limits, 
                       breaks = weighted_mean_breaks,
                       labels = weighted_mean_labels,
                       oob = scales::squish) +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), limits = c(-80,90))+
  xlab("") +
  ylab("") +
  map_theme + 
  guides(fill=guide_colorbar(
   title.position = "left",
   title.hjust = 0.5,
   frame.colour = "white",
   barwidth=4,
   barheight=0.25,
   default.unit="inch"))

w_mean_subsidy_intensity_tot_grid_map

ggsave(paste0(results_dir, "w_mean_subsidy_intensity_tot_grid_map.png"), dpi = 200, width = 7, height = 5)

# Bad subs
w_mean_subsidy_intensity_B_grid_map <- subsidy_intensity_binned %>%
  ggplot()+
  geom_tile(aes(x = lon_bin_center, y=lat_bin_center, fill = w_mean_B_subs_KWh)) +
  geom_sf(data=world_land, color = NA, fill="grey30") +
  scale_fill_viridis_c(name="Weighted Mean Subsidy Intensity \n($/KWh)", 
                       na.value = "#000000", 
                       limits = weighted_mean_limits, 
                       breaks = weighted_mean_breaks,
                       labels = weighted_mean_labels,
                       oob = scales::squish) +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), limits = c(-80,90))+
  xlab("") +
  ylab("") +
  map_theme + 
  guides(fill=guide_colorbar(
   title.position = "left",
   title.hjust = 0.5,
   frame.colour = "white",
   barwidth=4,
   barheight=0.25,
   default.unit="inch"))

w_mean_subsidy_intensity_B_grid_map

ggsave(paste0(results_dir, "w_mean_subsidy_intensity_B_grid_map.png"), dpi = 200, width = 7, height = 5)

# Bad and ambiguous subs
w_mean_subsidy_intensity_BC_grid_map <- subsidy_intensity_binned %>%
  ggplot()+
  geom_tile(aes(x = lon_bin_center, y=lat_bin_center, fill = w_mean_BC_subs_KWh)) +
  geom_sf(data=world_land, color = NA, fill="grey30") +
  scale_fill_viridis_c(name="Weighted Mean Subsidy Intensity \n($/KWh)", 
                       na.value = "#000000", 
                       limits = weighted_mean_limits, 
                       breaks = weighted_mean_breaks,
                       labels = weighted_mean_labels,
                       oob = scales::squish) +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), limits = c(-80,90))+
  xlab("") +
  ylab("") +
  map_theme + 
  guides(fill=guide_colorbar(
   title.position = "left",
   title.hjust = 0.5,
   frame.colour = "white",
   barwidth=4,
   barheight=0.25,
   default.unit="inch"))

w_mean_subsidy_intensity_BC_grid_map

ggsave(paste0(results_dir, "w_mean_subsidy_intensity_BC_grid_map.png"), dpi = 200, width = 7, height = 5)
```

```{r}
region_weighted_mean_breaks <- seq(0,4, by = 1)
region_weighted_mean_limits <- c(0,4)
region_weighted_mean_labels <- c("0", "1", "2", "3", paste0("\u2265","4"))

# Tot subs
w_mean_subsidy_intensity_tot_region_map <- subsidy_intensity_region %>%
  right_join(fao_regions, by = "fao_region") %>%
  ggplot()+
  geom_sf(aes(geometry = geometry, fill = w_mean_tot_subs_KWh)) +
  geom_sf(data=world_land, color = NA, fill="grey30") +
  scale_fill_viridis_c(name="Weighted Mean Subsidy Intensity \n($/KWh)", 
                       na.value = "#000000", 
                       limits = region_weighted_mean_limits, 
                       breaks = region_weighted_mean_breaks,
                       labels = region_weighted_mean_labels,
                       oob = scales::squish) +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), limits = c(-80,90))+
  xlab("") +
  ylab("") +
  map_theme + 
  guides(fill=guide_colorbar(
   title.position = "left",
   title.hjust = 0.5,
   frame.colour = "white",
   barwidth=4,
   barheight=0.25,
   default.unit="inch"))

w_mean_subsidy_intensity_tot_region_map

ggsave(paste0(results_dir, "w_mean_subsidy_intensity_tot_region_map.png"), dpi = 200, width = 7, height = 5)

# Bad subs
w_mean_subsidy_intensity_B_region_map <- subsidy_intensity_region %>%
  right_join(fao_regions, by = "fao_region") %>%
  ggplot()+
  geom_sf(aes(geometry = geometry, fill = w_mean_B_subs_KWh)) +
  geom_sf(data=world_land, color = NA, fill="grey30") +
  scale_fill_viridis_c(name="Weighted Mean Subsidy Intensity \n($/KWh)", 
                       na.value = "#000000", 
                       limits = region_weighted_mean_limits, 
                       breaks = region_weighted_mean_breaks,
                       labels = region_weighted_mean_labels,
                       oob = scales::squish) +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), limits = c(-80,90))+
  xlab("") +
  ylab("") +
  map_theme + 
  guides(fill=guide_colorbar(
   title.position = "left",
   title.hjust = 0.5,
   frame.colour = "white",
   barwidth=4,
   barheight=0.25,
   default.unit="inch"))

w_mean_subsidy_intensity_B_region_map

ggsave(paste0(results_dir, "w_mean_subsidy_intensity_B_region_map.png"), dpi = 200, width = 7, height = 5)

# Bad and ambiguous subs
w_mean_subsidy_intensity_BC_region_map <- subsidy_intensity_region %>%
  right_join(fao_regions, by = "fao_region") %>%
  ggplot()+
  geom_sf(aes(geometry = geometry, fill = w_mean_BC_subs_KWh)) +
  geom_sf(data=world_land, color = NA, fill="grey30") +
  scale_fill_viridis_c(name="Weighted Mean Subsidy Intensity \n($/KWh)", 
                       na.value = "#000000", 
                       limits = region_weighted_mean_limits, 
                       breaks = region_weighted_mean_breaks,
                       labels = region_weighted_mean_labels,
                       oob = scales::squish) +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), limits = c(-80,90))+
  xlab("") +
  ylab("") +
  map_theme + 
  guides(fill=guide_colorbar(
   title.position = "left",
   title.hjust = 0.5,
   frame.colour = "white",
   barwidth=4,
   barheight=0.25,
   default.unit="inch"))

w_mean_subsidy_intensity_BC_region_map

ggsave(paste0(results_dir, "w_mean_subsidy_intensity_BC_region_map.png"), dpi = 200, width = 7, height = 5)
```

### Overfishing status 

Now we load the upsides database, calculate mean and median F/Fmsy by FAO region, and plot. 

```{r}
upsides_dat <- read_csv(upsides_dat_path) 

upsides_region <- upsides_dat %>%
  group_by(region_fao_split) %>%
  summarize(mean_f_v_fmsy = mean(fv_fmsy, na.rm = T),
            w_mean_f_v_fmsy = weighted.mean(fv_fmsy, w = msy, na.rm = T),
            med_f_v_fmsy = median(fv_fmsy, na.rm = T),
            mean_b_v_bmsy = mean(bv_bmsy, na.rm = T),
            w_mean_b_v_bmsy = weighted.mean(bv_bmsy, w = msy, na.rm = T),
            med_b_v_bmsy = median(bv_bmsy, na.rm = T),
            tot_msy = sum(msy, na.rm = T)) %>%
  rename(fao_region = region_fao_split) %>%
  right_join(fao_regions, by = c("fao_region"))

```

Mean F/Fmsy by region. 

```{r}
mean_f_v_fmsy_region_map <- ggplot()+
  geom_sf(data=upsides_region, color = "black", aes(geometry = geometry, fill = mean_f_v_fmsy)) +
  geom_sf(data=world_land, color = NA, fill="grey30") +
  #geom_sf(data=eez_boundaries, color="grey80", size=0.1, aes(group = mrgid_eez)) +
  scale_fill_viridis_c(name="Mean F/Fmsy", 
                       na.value = "#000000") +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), limits = c(-80,90))+
  xlab("") +
  ylab("") +
  map_theme + 
  guides(fill=guide_colorbar(
   title.position = "left",
   title.hjust = 0.5,
   frame.colour = "white",
   barwidth=4,
   barheight=0.25,
   default.unit="inch"))

mean_f_v_fmsy_region_map

ggsave(paste0(results_dir, "mean_f_v_fmsy_region_map.png"), dpi = 200, width = 7, height = 5)
```

Weighted mean F/Fmsy by region (weighted by MSY of each stock). 

```{r}
w_mean_f_v_fmsy_region_map <- ggplot()+
  geom_sf(data=upsides_region, color = "black", aes(geometry = geometry, fill = w_mean_f_v_fmsy)) +
  geom_sf(data=world_land, color = NA, fill="grey30") +
  #geom_sf(data=eez_boundaries, color="grey80", size=0.1, aes(group = mrgid_eez)) +
  scale_fill_viridis_c(name="Weighted Mean F/Fmsy", na.value = "#000000") +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), limits = c(-80,90))+
  xlab("") +
  ylab("") +
  map_theme + 
  guides(fill=guide_colorbar(
   title.position = "left",
   title.hjust = 0.5,
   frame.colour = "white",
   barwidth=4,
   barheight=0.25,
   default.unit="inch"))

w_mean_f_v_fmsy_region_map

ggsave(paste0(results_dir, "w_mean_f_v_fmsy_region_map.png"), dpi = 200, width = 7, height = 5)
```

Median F/Fmsy by region.

```{r}
median_f_v_fmsy_region_map <- ggplot()+
  geom_sf(data=upsides_region, color = "black", aes(geometry = geometry, fill = med_f_v_fmsy)) +
  geom_sf(data=world_land, color = NA, fill="grey30") +
  #geom_sf(data=eez_boundaries, color="grey80", size=0.1, aes(group = mrgid_eez)) +
  scale_fill_viridis_c(name="Median F/Fmsy", na.value = "#000000") +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), limits = c(-80,90))+
  xlab("") +
  ylab("") +
  map_theme +
  guides(fill=guide_colorbar(
   title.position = "left",
   title.hjust = 0.5,
   frame.colour = "white",
   barwidth=4,
   barheight=0.25,
   default.unit="inch"))

median_f_v_fmsy_region_map

ggsave(paste0(results_dir, "median_f_v_fmsy_region_map.png"), dpi = 200, width = 7, height = 5)
```

### Combine

```{r}
subsidy_intensity_upsides_region <- upsides_region %>%
  left_join(subsidy_intensity_region, by = "fao_region")

# Weighted mean of Bad + Ambig vs F/Fmsy
w_mean_BC_vs_f_v_fmsy_plot <- ggplot(subsidy_intensity_upsides_region)+
  aes(x = w_mean_BC_subs_KWh, y = w_mean_f_v_fmsy, size = tot_fishing_KWh, color = tot_fishing_KWh)+
  geom_point()+
  scale_color_viridis_c(name="Total Fishing Effort \n(KWh)", na.value = "#000000")+
  scale_x_continuous(limits = c(0,2))+
  scale_y_continuous(limits = c(0,2.5))+
  xlab("Weighted Mean Subsidy Intensity ($/KWh)") +
  ylab("Weighted Mean F/Fmsy") +
  geom_hline(yintercept = 1, linetype = "dashed")+
  geom_vline(xintercept = 1, linetype = "dashed")+
  plot_theme+
  guides(color=guide_colorbar(
   title.position = "left",
   title.hjust = 0.5,
   frame.colour = "white",
   barwidth=4,
   barheight=0.25,
   default.unit="inch"),
   size = "none")

w_mean_BC_vs_f_v_fmsy_plot

ggsave(paste0(results_dir, "w_mean_BC_vs_f_v_fmsy_plot.png"), dpi = 200, width = 7, height = 7)
```


