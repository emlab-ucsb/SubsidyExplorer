---
output:
  html_document: default

title: "Paper # 1 - Figures"
author: "Kat Millage"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 11pt
---

# Description

```{r setup, include=FALSE}
# Load packages
library(knitr) 
library(countrycode) # country name matching
library(sf)
library(rworldmap)
library(rmapshaper)
library(RColorBrewer)
library(cowplot)
library(tidyverse)

source(here::here("functions", "MapMaker.R"))

# Path to cleaned subsidies data file
subsidy_dat_sumaila_path <- here::here("data", "edited", "sumaila_et_al_2019_subsidies_tidy.csv")

# Path to binned effort data file
effort_dat_binned_path <- here::here("results", "02-vessel-list", "effort_binned_good_fishing_vessels_2018_raw.csv")

# Path to upsides data file 
upsides_dat_path <- here::here("data", "edited", "costello_et_al_2016_upsides_tidy.csv")

# Chunk options
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F, prompt = F, error = F)

# Directories for the output files generated by this script
results_dir <- here::here("papers", "paper-1/")
if (dir.exists(results_dir) == F) {
  dir.create(results_dir, recursive = T)
}
```

```{r}
# Land shapefile
world_land <- st_as_sf(rworldmap::countriesLow) ## data(countriesLow) is from the rworldmap package

# FAO regions
fao_regions <- read_sf(here::here("data", "shapefiles", "fao"), layer = "World_Fao_Zones") %>%
  rename(fao_region = zone) %>%
  rmapshaper::ms_simplify(keep = 0.05)
```

# Version 1: Binned effort and median F/Fmsy by FAO region

```{r}
effort_binned_good_fishing_vessels_2018 <- read_csv(effort_dat_binned_path)
```

# Correct outdated flag codes and Identify EU and USA dependent vessels

Before allocating catches and subsidies across vessels, we need to identify vessels flagged to states that are overseas dependencies of the EU or USA. We assume that these vessels recieve subsidies from their sovereign states and therefore their fishing efforts should be included in the totals. 

```{r}
# Load country dependencies helper file
country_dependencies <- read_csv(here::here("data", "lookup-tables", "country_dependencies.csv"))

# Netherlands overseas territories
nld_territories <- country_dependencies$iso3[country_dependencies$is_overseas_territory & country_dependencies$sovereign_iso3 == "NLD"]

# France overseas territories
fra_territories <- country_dependencies$iso3[country_dependencies$is_overseas_territory & country_dependencies$sovereign_iso3 == "FRA"]

# Denmark overseas territories
dnk_territories <- country_dependencies$iso3[country_dependencies$is_overseas_territory & country_dependencies$sovereign_iso3 == "DNK"]

# British overseas territories
gbr_territories <- country_dependencies$iso3[country_dependencies$is_overseas_territory & country_dependencies$sovereign_iso3 == "GBR"]

# Norway overseas territories
nor_territories <- country_dependencies$iso3[country_dependencies$is_overseas_territory & country_dependencies$sovereign_iso3 == "NOR"]

# US overseas territories:  American Samoa, Guam, Northern Marianas Islands, Puerto Rico, US Virgin Islands
usa_territories <- country_dependencies$iso3[country_dependencies$is_overseas_territory & country_dependencies$sovereign_iso3 == "USA"]

# Australian overseas territories: Christmas Island
aus_territories <- country_dependencies$iso3[country_dependencies$is_overseas_territory & country_dependencies$sovereign_iso3 == "AUS"]
```

We apply these to our binned fishing effort

```{r}
effort_binned <- effort_binned_good_fishing_vessels_2018 %>%
  mutate(new_flag = case_when(flag %in% nld_territories ~ "NLD",
                              flag %in% fra_territories ~ "FRA",
                              flag %in% dnk_territories ~ "DNK",
                              flag %in% gbr_territories ~ "GBR",
                              flag %in% nor_territories ~ "NOR",
                              flag %in% usa_territories ~ "USA",
                              flag %in% aus_territories ~ "AUS",
                              flag == "COK" ~ "NZL", # for now assign cook islands to new zealand
                              TRUE ~ flag))

effort_binned$new_flag[effort_binned$new_flag == "GCA"] <- "GTM"
effort_binned$new_flag[effort_binned$new_flag == "ROM"] <- "ROU"
effort_binned$new_flag[effort_binned$new_flag == "UNK"] <- NA
```

### Subsidy intensities

Now lets get fishing effort totals by flag state

```{r}
effort_totals_flag <- effort_binned %>%
  group_by(new_flag) %>%
  summarize(fishing_KWh_lat_lon = sum(fishing_KWh_lat_lon, na.rm = T),
            fishing_hours_lat_lon = sum(fishing_hours_lat_lon, na.rm = T))
```

We then load our subsidy data, and calculate subsidy rates by flag for 2018. Subsidy rates are then applied to our binned effort data by flag. 

```{r}
subsidy_dat_sumaila <- read_csv(subsidy_dat_sumaila_path) %>%
  group_by(iso3, category) %>%
  summarize(subs = sum(value, na.rm = T)) %>%
  spread(category, subs) %>%
  rename(A_subs = A,
         B_subs = B,
         C_subs = C) %>%
  mutate(BC_subs = B_subs + C_subs,
         tot_subs = A_subs + B_subs + C_subs)
```

```{r}
# Calculate subsidy rates by flag
subsidy_rates_flag <- effort_totals_flag %>%
  left_join(subsidy_dat_sumaila, by = c("new_flag" = "iso3")) %>%
  mutate(A_subs_KWh = A_subs/fishing_KWh_lat_lon,
         B_subs_KWh = B_subs/fishing_KWh_lat_lon,
         C_subs_KWh = C_subs/fishing_KWh_lat_lon,
         BC_subs_KWh = BC_subs/fishing_KWh_lat_lon,
         tot_subs_KWh = tot_subs/fishing_KWh_lat_lon) %>%
  dplyr::select(new_flag, contains("subs_KWh"))

# Apply subsidy rates to binned effort
effort_binned_sub_intensity <- effort_binned %>%
  left_join(subsidy_rates_flag, by = "new_flag") %>%
  mutate(B_subs = B_subs_KWh*fishing_KWh_lat_lon,
         BC_subs = BC_subs_KWh*fishing_KWh_lat_lon,
         C_subs = C_subs_KWh*fishing_KWh_lat_lon,
         tot_subs = tot_subs_KWh*fishing_KWh_lat_lon)

# Summarize by lat/lon
subsidy_intensity_binned <- effort_binned_sub_intensity %>%
  group_by(lat_bin_center, lon_bin_center) %>%
  summarize(med_B_subs_KWh = median(B_subs_KWh, na.rm = T),
            med_BC_subs_KWh = median(BC_subs_KWh, na.rm = T),
            med_tot_subs_KWh = median(tot_subs_KWh, na.rm = T),
            mean_B_subs_KWh = mean(B_subs_KWh, na.rm = T),
            mean_BC_subs_KWh = mean(BC_subs_KWh, na.rm = T),
            mean_tot_subs_KWh = mean(tot_subs_KWh, na.rm = T),
            w_mean_B_subs_KWh = weighted.mean(B_subs_KWh, w = fishing_KWh_lat_lon, na.rm = T),
            w_mean_BC_subs_KWh = weighted.mean(BC_subs_KWh, w = fishing_KWh_lat_lon, na.rm = T),
            w_mean_tot_subs_KWh = weighted.mean(tot_subs_KWh, w = fishing_KWh_lat_lon, na.rm = T),
            B_subs = sum(B_subs, na.rm = T),
            BC_subs = sum(BC_subs, na.rm = T),
            C_subs = sum(C_subs, na.rm = T),
            tot_subs = sum(tot_subs, na.rm = T),
            tot_fishing_KWh = sum(fishing_KWh_lat_lon, na.rm = T))

# Summarize by fao region
subsidy_intensity_region <- effort_binned_sub_intensity %>%
  group_by(fao_region) %>%
  summarize(med_B_subs_KWh = median(B_subs_KWh, na.rm = T),
            med_BC_subs_KWh = median(BC_subs_KWh, na.rm = T),
            med_tot_subs_KWh = median(tot_subs_KWh, na.rm = T),
            mean_B_subs_KWh = mean(B_subs_KWh, na.rm = T),
            mean_BC_subs_KWh = mean(BC_subs_KWh, na.rm = T),
            mean_tot_subs_KWh = mean(tot_subs_KWh, na.rm = T),
            w_mean_B_subs_KWh = weighted.mean(B_subs_KWh, w = fishing_KWh_lat_lon, na.rm = T),
            w_mean_BC_subs_KWh = weighted.mean(BC_subs_KWh, w = fishing_KWh_lat_lon, na.rm = T),
            w_mean_tot_subs_KWh = weighted.mean(tot_subs_KWh, w = fishing_KWh_lat_lon, na.rm = T),
            B_subs = sum(B_subs, na.rm = T),
            BC_subs = sum(BC_subs, na.rm = T),
            C_subs = sum(C_subs, na.rm = T),
            tot_subs = sum(tot_subs, na.rm = T),
            tot_fishing_KWh = sum(fishing_KWh_lat_lon, na.rm = T))
```

Now we go back to our effort data, and apply our subsidy rates. 

## Total Subsidies

### Subsidy Intensities by Lat/Lon

```{r}
# Median
median_subsidy_intensity_tot_grid_map <- MapMaker(data = subsidy_intensity_binned,
                                                  res = "grid",
                                                  x = "lon_bin_center",
                                                  y = "lat_bin_center",
                                                  fill = "med_tot_subs_KWh",
                                                  fill_name = "Subsidy Intensity \n($/KWh)",
                                                  fill_breaks = seq(0,8, by = 2),
                                                  fill_limits = c(0,8),
                                                  fill_labels = c("0", "2", "4", "6", "8"),
                                                  land_sf = world_land)

ggsave(paste0(results_dir, "median_subsidy_intensity_tot_grid_map.png"), dpi = 200, width = 7, height = 5)

# Mean
mean_subsidy_intensity_tot_grid_map <- MapMaker(data = subsidy_intensity_binned,
                                                  res = "grid",
                                                  x = "lon_bin_center",
                                                  y = "lat_bin_center",
                                                  fill = "mean_tot_subs_KWh",
                                                  fill_name = "Subsidy Intensity \n($/KWh)",
                                                  fill_breaks = seq(0,8, by = 2),
                                                  fill_limits = c(0,8),
                                                  fill_labels = c("0", "2", "4", "6", "8"),
                                                  land_sf = world_land)

ggsave(paste0(results_dir, "mean_subsidy_intensity_tot_grid_map.png"), dpi = 200, width = 7, height = 5)

# Weighted Mean
w_mean_subsidy_intensity_tot_grid_map <- MapMaker(data = subsidy_intensity_binned,
                                                  res = "grid",
                                                  x = "lon_bin_center",
                                                  y = "lat_bin_center",
                                                  fill = "w_mean_tot_subs_KWh",
                                                  fill_name = "Subsidy Intensity \n($/KWh)",
                                                  fill_breaks = seq(0,8, by = 2),
                                                  fill_limits = c(0,8),
                                                  fill_labels = c("0", "2", "4", "6", "8"),
                                                  land_sf = world_land)

ggsave(paste0(results_dir, "w_mean_subsidy_intensity_tot_grid_map.png"), dpi = 200, width = 7, height = 5)

# Combine into three panel
intensity_tot_grid_legend <- get_legend(w_mean_subsidy_intensity_tot_grid_map)

subsidy_intensity_tot_grid_map <- plot_grid(median_subsidy_intensity_tot_grid_map + theme(legend.position = "none"),
                                            mean_subsidy_intensity_tot_grid_map + theme(legend.position = "none"),
                                            w_mean_subsidy_intensity_tot_grid_map + theme(legend.position = "none"),
                                            intensity_tot_grid_legend,
                                            ncol = 1,
                                            rel_heights = c(1,1,1,0.2),
                                            labels = c("A) Median", "B) Mean", "C) Weighted Mean", ""),
                                            label_x = c(-0.04,-0.03,-0.1,0),
                                            align = "v")

subsidy_intensity_tot_grid_map
ggsave(paste0(results_dir, "subsidy_intensity_tot_grid_map.png"), dpi = 200, width = 7, height = 12.5)

```

### Subsidy Intensities by Region

```{r}
# Median
median_subsidy_intensity_tot_region_map <- MapMaker(data = subsidy_intensity_region,
                                                  res = "region",
                                                  fill = "med_tot_subs_KWh",
                                                  fill_name = "Subsidy Intensity \n($/KWh)",
                                                  fill_breaks = seq(0,8, by = 2),
                                                  fill_limits = c(0,8),
                                                  fill_labels = c("0", "2", "4", "6", "8"),
                                                  land_sf = world_land,
                                                  region_sf = fao_regions)

ggsave(paste0(results_dir, "median_subsidy_intensity_tot_region_map.png"), dpi = 200, width = 7, height = 5)

# Mean
mean_subsidy_intensity_tot_region_map <- MapMaker(data = subsidy_intensity_region,
                                                  res = "region",
                                                  fill = "mean_tot_subs_KWh",
                                                  fill_name = "Subsidy Intensity \n($/KWh)",
                                                  fill_breaks = seq(0,8, by = 2),
                                                  fill_limits = c(0,8),
                                                  fill_labels = c("0", "2", "4", "6", "8"),
                                                  land_sf = world_land,
                                                  region_sf = fao_regions)

ggsave(paste0(results_dir, "mean_subsidy_intensity_tot_region_map.png"), dpi = 200, width = 7, height = 5)

# Weighted Mean
w_mean_subsidy_intensity_tot_region_map <- MapMaker(data = subsidy_intensity_region,
                                                  res = "region",
                                                  fill = "w_mean_tot_subs_KWh",
                                                  fill_name = "Subsidy Intensity \n($/KWh)",
                                                  fill_breaks = seq(0,8, by = 2),
                                                  fill_limits = c(0,8),
                                                  fill_labels = c("0", "2", "4", "6", "8"),
                                                  land_sf = world_land,
                                                  region_sf = fao_regions)

ggsave(paste0(results_dir, "w_mean_subsidy_intensity_tot_region_map.png"), dpi = 200, width = 7, height = 5)

# Combine into three panel
intensity_tot_region_legend <- get_legend(w_mean_subsidy_intensity_tot_region_map)

subsidy_intensity_tot_region_map <- plot_grid(median_subsidy_intensity_tot_region_map + theme(legend.position = "none"),
                                            mean_subsidy_intensity_tot_region_map + theme(legend.position = "none"),
                                            w_mean_subsidy_intensity_tot_region_map + theme(legend.position = "none"),
                                            intensity_tot_region_legend,
                                            ncol = 1,
                                            rel_heights = c(1,1,1,0.2),
                                            labels = c("A) Median", "B) Mean", "C) Weighted Mean", ""),
                                            label_x = c(-0.04,-0.03,-0.1,0),
                                            align = "v")

subsidy_intensity_tot_region_map
ggsave(paste0(results_dir, "subsidy_intensity_tot_region_map.png"), dpi = 200, width = 7, height = 12.5)

```

## Bad Subsidies

### Subsidy Intensities by Lat/Lon

```{r}
# Median
median_subsidy_intensity_B_grid_map <- MapMaker(data = subsidy_intensity_binned,
                                                  res = "grid",
                                                  x = "lon_bin_center",
                                                  y = "lat_bin_center",
                                                  fill = "med_B_subs_KWh",
                                                  fill_name = "Subsidy Intensity \n($/KWh)",
                                                  fill_breaks = seq(0,8, by = 2),
                                                  fill_limits = c(0,8),
                                                  fill_labels = c("0", "2", "4", "6", "8"),
                                                  land_sf = world_land)

ggsave(paste0(results_dir, "median_subsidy_intensity_B_grid_map.png"), dpi = 200, width = 7, height = 5)

# Mean
mean_subsidy_intensity_B_grid_map <- MapMaker(data = subsidy_intensity_binned,
                                                  res = "grid",
                                                  x = "lon_bin_center",
                                                  y = "lat_bin_center",
                                                  fill = "mean_B_subs_KWh",
                                                  fill_name = "Subsidy Intensity \n($/KWh)",
                                                  fill_breaks = seq(0,8, by = 2),
                                                  fill_limits = c(0,8),
                                                  fill_labels = c("0", "2", "4", "6", "8"),
                                                  land_sf = world_land)

ggsave(paste0(results_dir, "mean_subsidy_intensity_B_grid_map.png"), dpi = 200, width = 7, height = 5)

# Weighted Mean
w_mean_subsidy_intensity_B_grid_map <- MapMaker(data = subsidy_intensity_binned,
                                                  res = "grid",
                                                  x = "lon_bin_center",
                                                  y = "lat_bin_center",
                                                  fill = "w_mean_B_subs_KWh",
                                                  fill_name = "Subsidy Intensity \n($/KWh)",
                                                  fill_breaks = seq(0,8, by = 2),
                                                  fill_limits = c(0,8),
                                                  fill_labels = c("0", "2", "4", "6", "8"),
                                                  land_sf = world_land)

ggsave(paste0(results_dir, "w_mean_subsidy_intensity_B_grid_map.png"), dpi = 200, width = 7, height = 5)

# Combine into three panel
intensity_B_grid_legend <- get_legend(w_mean_subsidy_intensity_B_grid_map)

subsidy_intensity_B_grid_map <- plot_grid(median_subsidy_intensity_B_grid_map + theme(legend.position = "none"),
                                            mean_subsidy_intensity_B_grid_map + theme(legend.position = "none"),
                                            w_mean_subsidy_intensity_B_grid_map + theme(legend.position = "none"),
                                            intensity_B_grid_legend,
                                            ncol = 1,
                                            rel_heights = c(1,1,1,0.2),
                                            labels = c("A) Median", "B) Mean", "C) Weighted Mean", ""),
                                            label_x = c(-0.04,-0.03,-0.1,0),
                                            align = "v")

subsidy_intensity_B_grid_map
ggsave(paste0(results_dir, "subsidy_intensity_B_grid_map.png"), dpi = 200, width = 7, height = 12.5)

```

### Subsidy Intensities by Region

```{r}
# Median
median_subsidy_intensity_B_region_map <- MapMaker(data = subsidy_intensity_region,
                                                  res = "region",
                                                  fill = "med_B_subs_KWh",
                                                  fill_name = "Subsidy Intensity \n($/KWh)",
                                                  fill_breaks = seq(0,8, by = 2),
                                                  fill_limits = c(0,8),
                                                  fill_labels = c("0", "2", "4", "6", "8"),
                                                  land_sf = world_land,
                                                  region_sf = fao_regions)

ggsave(paste0(results_dir, "median_subsidy_intensity_B_region_map.png"), dpi = 200, width = 7, height = 5)

# Mean
mean_subsidy_intensity_B_region_map <- MapMaker(data = subsidy_intensity_region,
                                                  res = "region",
                                                  fill = "mean_B_subs_KWh",
                                                  fill_name = "Subsidy Intensity \n($/KWh)",
                                                  fill_breaks = seq(0,8, by = 2),
                                                  fill_limits = c(0,8),
                                                  fill_labels = c("0", "2", "4", "6", "8"),
                                                  land_sf = world_land,
                                                  region_sf = fao_regions)

ggsave(paste0(results_dir, "mean_subsidy_intensity_B_region_map.png"), dpi = 200, width = 7, height = 5)

# Weighted Mean
w_mean_subsidy_intensity_B_region_map <- MapMaker(data = subsidy_intensity_region,
                                                  res = "region",
                                                  fill = "w_mean_B_subs_KWh",
                                                  fill_name = "Subsidy Intensity \n($/KWh)",
                                                  fill_breaks = seq(0,8, by = 2),
                                                  fill_limits = c(0,8),
                                                  fill_labels = c("0", "2", "4", "6", "8"),
                                                  land_sf = world_land,
                                                  region_sf = fao_regions)

ggsave(paste0(results_dir, "w_mean_subsidy_intensity_B_region_map.png"), dpi = 200, width = 7, height = 5)

# Combine into three panel
intensity_B_region_legend <- get_legend(w_mean_subsidy_intensity_B_region_map)

subsidy_intensity_B_region_map <- plot_grid(median_subsidy_intensity_B_region_map + theme(legend.position = "none"),
                                            mean_subsidy_intensity_B_region_map + theme(legend.position = "none"),
                                            w_mean_subsidy_intensity_B_region_map + theme(legend.position = "none"),
                                            intensity_B_region_legend,
                                            ncol = 1,
                                            rel_heights = c(1,1,1,0.2),
                                            labels = c("A) Median", "B) Mean", "C) Weighted Mean", ""),
                                            label_x = c(-0.04,-0.03,-0.1,0),
                                            align = "v")

subsidy_intensity_B_region_map
ggsave(paste0(results_dir, "subsidy_intensity_B_region_map.png"), dpi = 200, width = 7, height = 12.5)

```

## Bad + Ambiguous Subsidies

### Subsidy Intensities by Lat/Lon

```{r}
# Median
median_subsidy_intensity_BC_grid_map <- MapMaker(data = subsidy_intensity_binned,
                                                  res = "grid",
                                                  x = "lon_bin_center",
                                                  y = "lat_bin_center",
                                                  fill = "med_BC_subs_KWh",
                                                  fill_name = "Subsidy Intensity \n($/KWh)",
                                                  fill_breaks = seq(0,8, by = 2),
                                                  fill_limits = c(0,8),
                                                  fill_labels = c("0", "2", "4", "6", "8"),
                                                  land_sf = world_land)

ggsave(paste0(results_dir, "median_subsidy_intensity_BC_grid_map.png"), dpi = 200, width = 7, height = 5)

# Mean
mean_subsidy_intensity_BC_grid_map <- MapMaker(data = subsidy_intensity_binned,
                                                  res = "grid",
                                                  x = "lon_bin_center",
                                                  y = "lat_bin_center",
                                                  fill = "mean_BC_subs_KWh",
                                                  fill_name = "Subsidy Intensity \n($/KWh)",
                                                  fill_breaks = seq(0,8, by = 2),
                                                  fill_limits = c(0,8),
                                                  fill_labels = c("0", "2", "4", "6", "8"),
                                                  land_sf = world_land)

ggsave(paste0(results_dir, "mean_subsidy_intensity_BC_grid_map.png"), dpi = 200, width = 7, height = 5)

# Weighted Mean
w_mean_subsidy_intensity_BC_grid_map <- MapMaker(data = subsidy_intensity_binned,
                                                  res = "grid",
                                                  x = "lon_bin_center",
                                                  y = "lat_bin_center",
                                                  fill = "w_mean_BC_subs_KWh",
                                                  fill_name = "Subsidy Intensity \n($/KWh)",
                                                  fill_breaks = seq(0,8, by = 2),
                                                  fill_limits = c(0,8),
                                                  fill_labels = c("0", "2", "4", "6", "8"),
                                                  land_sf = world_land)

ggsave(paste0(results_dir, "w_mean_subsidy_intensity_BC_grid_map.png"), dpi = 200, width = 7, height = 5)

# Combine into three panel
intensity_BC_grid_legend <- get_legend(w_mean_subsidy_intensity_BC_grid_map)

subsidy_intensity_BC_grid_map <- plot_grid(median_subsidy_intensity_BC_grid_map + theme(legend.position = "none"),
                                            mean_subsidy_intensity_BC_grid_map + theme(legend.position = "none"),
                                            w_mean_subsidy_intensity_BC_grid_map + theme(legend.position = "none"),
                                            intensity_BC_grid_legend,
                                            ncol = 1,
                                            rel_heights = c(1,1,1,0.2),
                                            labels = c("A) Median", "B) Mean", "C) Weighted Mean", ""),
                                            label_x = c(-0.04,-0.03,-0.1,0),
                                            align = "v")

subsidy_intensity_BC_grid_map
ggsave(paste0(results_dir, "subsidy_intensity_BC_grid_map.png"), dpi = 200, width = 7, height = 12.5)

```

### Subsidy Intensities by Region

```{r}
# Median
median_subsidy_intensity_BC_region_map <- MapMaker(data = subsidy_intensity_region,
                                                  res = "region",
                                                  fill = "med_BC_subs_KWh",
                                                  fill_name = "Subsidy Intensity \n($/KWh)",
                                                  fill_breaks = seq(0,8, by = 2),
                                                  fill_limits = c(0,8),
                                                  fill_labels = c("0", "2", "4", "6", "8"),
                                                  land_sf = world_land,
                                                  region_sf = fao_regions)

ggsave(paste0(results_dir, "median_subsidy_intensity_BC_region_map.png"), dpi = 200, width = 7, height = 5)

# Mean
mean_subsidy_intensity_BC_region_map <- MapMaker(data = subsidy_intensity_region,
                                                  res = "region",
                                                  fill = "mean_BC_subs_KWh",
                                                  fill_name = "Subsidy Intensity \n($/KWh)",
                                                  fill_breaks = seq(0,8, by = 2),
                                                  fill_limits = c(0,8),
                                                  fill_labels = c("0", "2", "4", "6", "8"),
                                                  land_sf = world_land,
                                                  region_sf = fao_regions)

ggsave(paste0(results_dir, "mean_subsidy_intensity_BC_region_map.png"), dpi = 200, width = 7, height = 5)

# Weighted Mean
w_mean_subsidy_intensity_BC_region_map <- MapMaker(data = subsidy_intensity_region,
                                                  res = "region",
                                                  fill = "w_mean_BC_subs_KWh",
                                                  fill_name = "Subsidy Intensity \n($/KWh)",
                                                  fill_breaks = seq(0,8, by = 2),
                                                  fill_limits = c(0,8),
                                                  fill_labels = c("0", "2", "4", "6", "8"),
                                                  land_sf = world_land,
                                                  region_sf = fao_regions)

ggsave(paste0(results_dir, "w_mean_subsidy_intensity_BC_region_map.png"), dpi = 200, width = 7, height = 5)

# Combine into three panel
intensity_BC_region_legend <- get_legend(w_mean_subsidy_intensity_BC_region_map)

subsidy_intensity_BC_region_map <- plot_grid(median_subsidy_intensity_BC_region_map + theme(legend.position = "none"),
                                            mean_subsidy_intensity_BC_region_map + theme(legend.position = "none"),
                                            w_mean_subsidy_intensity_BC_region_map + theme(legend.position = "none"),
                                            intensity_BC_region_legend,
                                            ncol = 1,
                                            rel_heights = c(1,1,1,0.2),
                                            labels = c("A) Median", "B) Mean", "C) Weighted Mean", ""),
                                            label_x = c(-0.04,-0.03,-0.1,0),
                                            align = "v")

subsidy_intensity_BC_region_map
ggsave(paste0(results_dir, "subsidy_intensity_BC_region_map.png"), dpi = 200, width = 7, height = 12.5)

```

## Stock status 

Now we load the upsides database, calculate mean and median F/Fmsy by FAO region, and plot. 

```{r}
upsides_dat <- read_csv(upsides_dat_path) 

upsides_region <- upsides_dat %>%
  group_by(region_fao_split) %>%
  summarize(mean_f_v_fmsy = mean(fv_fmsy, na.rm = T),
            w_mean_f_v_fmsy = weighted.mean(fv_fmsy, w = msy, na.rm = T),
            med_f_v_fmsy = median(fv_fmsy, na.rm = T),
            mean_b_v_bmsy = mean(bv_bmsy, na.rm = T),
            w_mean_b_v_bmsy = weighted.mean(bv_bmsy, w = msy, na.rm = T),
            med_b_v_bmsy = median(bv_bmsy, na.rm = T),
            tot_msy = sum(msy, na.rm = T)) %>%
  rename(fao_region = region_fao_split)

```

### F/Fmsy by Region

```{r}
# Median
median_f_v_fmsy_region_map <- MapMaker(data = upsides_region, 
                                     res = "region",
                                     fill = "med_f_v_fmsy",
                                     fill_name = "F/Fmsy",
                                     fill_breaks = seq(0,4, by = 1),
                                     fill_limits = c(0,4),
                                     fill_labels = c("0", "1", "2", "3", "4"),
                                     land_sf = world_land,
                                     region_sf = fao_regions)

ggsave(paste0(results_dir, "median_f_v_fmsy_region_map.png"), dpi = 200, width = 7, height = 5)

# Mean
mean_f_v_fmsy_region_map <- MapMaker(data = upsides_region, 
                                     res = "region",
                                     fill = "mean_f_v_fmsy",
                                     fill_name = "F/Fmsy",
                                     fill_breaks = seq(0,4, by = 1),
                                     fill_limits = c(0,4),
                                     fill_labels = c("0", "1", "2", "3", "4"),
                                     land_sf = world_land,
                                     region_sf = fao_regions)

ggsave(paste0(results_dir, "mean_f_v_fmsy_region_map.png"), dpi = 200, width = 7, height = 5)

# Weighted Mean
w_mean_f_v_fmsy_region_map <- MapMaker(data = upsides_region, 
                                     res = "region",
                                     fill = "w_mean_f_v_fmsy",
                                     fill_name = "F/Fmsy",
                                     fill_breaks = seq(0,4, by = 1),
                                     fill_limits = c(0,4),
                                     fill_labels = c("0", "1", "2", "3", "4"),
                                     land_sf = world_land,
                                     region_sf = fao_regions)

ggsave(paste0(results_dir, "w_mean_f_v_fmsy_region_map.png"), dpi = 200, width = 7, height = 5)

# Combine into three panel
f_v_fmsy_region_legend <- get_legend(w_mean_f_v_fmsy_region_map)

f_v_fmsy_region_map <- plot_grid(median_f_v_fmsy_region_map + theme(legend.position = "none"),
                                 mean_f_v_fmsy_region_map + theme(legend.position = "none"),
                                 w_mean_f_v_fmsy_region_map + theme(legend.position = "none"),
                                 f_v_fmsy_region_legend,
                                 ncol = 1,
                                 rel_heights = c(1, 1, 1, 0.2),
                                 labels = c("A) Median", "B) Mean", "C) Weighted Mean", ""),
                                 label_x = c(-0.04, -0.03, -0.1, 0),
                                 align = "v")

f_v_fmsy_region_map
ggsave(paste0(results_dir, "f_v_fmsy_region_map.png"), dpi = 200, width = 7, height = 12.5)
```


## Coorelation Between Subsidies and Stock status 

```{r}
subsidy_intensity_upsides_region <- upsides_region %>%
  left_join(subsidy_intensity_region, by = "fao_region")

# Weighted mean of Bad + Ambig vs Weighted mean F/Fmsy
w_mean_BC_vs_f_v_fmsy_plot <- MapMaker(data = subsidy_intensity_upsides_region,
                                       res = "corr",
                                       x = "w_mean_BC_subs_KWh",
                                       x_name = "Weighted Mean Subsidy Intensity ($/KWh)",
                                       x_limits = c(0,2),
                                       y = "w_mean_f_v_fmsy",
                                       y_name = "Weighted Mean F/Fmsy",
                                       y_limits = c(0,2.5),
                                       fill = "tot_fishing_KWh",
                                       fill_name = "Total Fishing Effort \n(KWh, billions)",
                                       fill_limits = c(0,7.5e9),
                                       fill_breaks = seq(0,7.5e9, length.out = 5),
                                       fill_labels = format(seq(0,7.5e9, length.out = 5)/1e9, scientific = F, digits = 2))

ggsave(paste0(results_dir, "w_mean_BC_vs_f_v_fmsy_plot.png"), dpi = 200, width = 7, height = 7)

# mean of Bad + Ambig vs mean F/Fmsy
w_mean_BC_vs_median_f_v_fmsy_plot <- MapMaker(data = subsidy_intensity_upsides_region,
                                       res = "corr",
                                       x = "w_mean_BC_subs_KWh",
                                       x_name = "Weighted Mean Subsidy Intensity ($/KWh)",
                                       x_limits = c(0,4),
                                       y = "med_f_v_fmsy",
                                       y_name = "Median F/Fmsy",
                                       y_limits = c(0,4),
                                       fill = "tot_fishing_KWh",
                                       fill_name = "Total Fishing Effort \n(KWh, billions)",
                                       fill_limits = c(0,7.5e9),
                                       fill_breaks = seq(0,7.5e9, length.out = 5),
                                       fill_labels = format(seq(0,7.5e9, length.out = 5)/1e9, scientific = F, digits = 2))


ggsave(paste0(results_dir, "w_mean_BC_vs_median_f_v_fmsy_plot.png"), dpi = 200, width = 7, height = 7)

```

## Figure 1

```{r}
top_legend <- get_legend(w_mean_subsidy_intensity_BC_region_map)

top_row <- plot_grid(
  plot_grid(w_mean_subsidy_intensity_BC_grid_map + theme(legend.position = "none"),
                     w_mean_subsidy_intensity_BC_region_map + theme(legend.position = "none"),
                     nrow = 1,
                     label_x = 0,
                     labels = c("A) Subsidy Itensity (1x1 degree)",
                                "B) Subsidy Intensity (FAO Region)")),
  ncol = 1,
  top_legend,
  rel_heights = c(1,0.2))


bottom_row <-  plot_grid(median_f_v_fmsy_region_map,
                     w_mean_BC_vs_median_f_v_fmsy_plot,
                     nrow = 1,
                     label_x = 0,
                     labels = c("C) F/Fmsy (FAO Region)",
                                "D) Coorelation"))

Figure1 <- plot_grid(top_row,
                     bottom_row,
                     nrow = 2)
         
ggsave(paste0(results_dir, "Figure1.png"), dpi = 200, width = 14, height = 9.5)
```


