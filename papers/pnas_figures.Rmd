---
output:
  html_document: default

title: "Paper # 1 - Figures"
author: "Kat Millage"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 11pt
---

# Description

```{r setup, include=FALSE}
# Load packages
library(knitr) 
library(countrycode) # country name matching
library(sf)
library(rworldmap)
library(tidyverse)

# Path to cleaned subsidies data file
subsidy_dat_sumaila_path <- here::here("data", "edited", "sumaila_et_al_2019_subsidies_tidy.csv")

# Path to binned effort data file
effort_dat_binned_path <- here::here("results", "01-vessel-list", "effort_binned_good_fishing_vessels_2018_raw.csv")

# Path to upsides data file 
#upsides_dat_path <- here::here("results", )

knitr::opts_chunk$set(echo = TRUE)

# Directories for the output files generated by this script
results_dir <- here::here("papers", "paper-1/")
if (dir.exists(results_dir) == F) {
  dir.create(results_dir, recursive = T)
}
```

# Version 1: Binned effort and median F/Fmsy by FAO region

```{r}
effort_binned_good_fishing_vessels_2018 <- read_csv(effort_dat_binned_path)
```

# Correct outdated flag codes and Identify EU and USA dependent vessels

Before allocating catches and subsidies across vessels, we need to identify vessels flagged to states that are overseas dependencies of the EU or USA. We assume that these vessels recieve subsidies from their sovereign states and therefore their fishing efforts should be included in the totals. 

```{r}
# Load country dependencies helper file
country_dependencies <- read_csv(here::here("data", "lookup-tables", "country_dependencies.csv"))

# EU countries
eu_countries <- country_dependencies$iso3[country_dependencies$is_EU]

# EU overseas territories
eu_territories <- country_dependencies$iso3[country_dependencies$is_overseas_territory & country_dependencies$sovereign_iso3 %in% eu_countries]

# US overseas territories:  American Samoa, Guam, Northern Marianas Islands, Puerto Rico, US Virgin Islands
us_territories <- country_dependencies$iso3[country_dependencies$is_overseas_territory & country_dependencies$sovereign_iso3 == "USA"]
```

We apply these to our binned fishing effort

```{r}
effort_binned <- effort_binned_good_fishing_vessels_2018 %>%
  mutate(is_eu = case_when(flag %in% c(eu_countries, eu_territories) ~ TRUE,
                           TRUE ~ FALSE),
         is_usa = case_when(flag %in% c(us_territories, "USA") ~ TRUE,
                            TRUE ~ FALSE),
         new_flag = case_when(is_eu ~ "EU", 
                              is_usa ~ "USA", 
                              TRUE ~ flag))

effort_binned$new_flag[effort_binned$new_flag == "GCA"] <- "GTM"
effort_binned$new_flag[effort_binned$new_flag == "ROM"] <- "ROU"
effort_binned$new_flag[effort_binned$new_flag == "UNK"] <- NA
```

Now lets get fishing effort totals by flag state

```{r}
effort_totals_flag <- effort_binned %>%
  group_by(new_flag) %>%
  summarize(fishing_KWh_lat_lon = sum(fishing_KWh_lat_lon, na.rm = T),
            fishing_hours_lat_lon = sum(fishing_hours_lat_lon, na.rm = T))
```

We then load our subsidy data, and calculate subsidy rates by flag for 2018. 

```{r}
subsidy_dat_sumaila <- read_csv(subsidy_dat_sumaila_path) %>%
  group_by(iso3, category) %>%
  summarize(subs = sum(value, na.rm = T)) %>%
  spread(category, subs) %>%
  rename(A_subs = A,
         B_subs = B,
         C_subs = C)
```

```{r}
subsidy_rates_flag <- effort_totals_flag %>%
  left_join(subsidy_dat_sumaila, by = c("new_flag" = "iso3")) %>%
  mutate(A_subs_KWh = A_subs/fishing_KWh_lat_lon,
         B_subs_KWh = B_subs/fishing_KWh_lat_lon,
         C_subs_KWh = C_subs/fishing_KWh_lat_lon,
         tot_subs_KWh = (A_subs+B_subs+C_subs)/fishing_KWh_lat_lon) %>%
  dplyr::select(new_flag, contains("subs_KWh"))

```

Now we go back to our effort data, and apply our subsidy rates and calculate the median subsidy intensity for each lat/lon bin

```{r}
effort_binned_med_sub_intensity <- effort_binned %>%
  left_join(subsidy_rates_flag, by = "new_flag") %>%
  group_by(year, lat_bin_center, lon_bin_center, fao_region) %>%
  summarize(med_A_subs_KWh = median(A_subs_KWh, na.rm = T),
            med_B_subs_KWh = median(B_subs_KWh, na.rm = T),
            med_C_subs_KWh = median(C_subs_KWh, na.rm = T),
            med_tot_subs_KWh = median(tot_subs_KWh, na.rm = T))

effort_binned_mean_sub_intensity <- effort_binned %>%
  left_join(subsidy_rates_flag, by = "new_flag") %>%
  group_by(year, lat_bin_center, lon_bin_center, fao_region) %>%
  summarize(mean_A_subs_KWh = mean(A_subs_KWh, na.rm = T),
            mean_B_subs_KWh = mean(B_subs_KWh, na.rm = T),
            mean_C_subs_KWh = mean(C_subs_KWh, na.rm = T),
            mean_tot_subs_KWh = mean(tot_subs_KWh, na.rm = T))
```

And plot...

```{r}
# Make land
world_land <- st_as_sf(rworldmap::countriesLow) ## data(countriesLow) is from the rworldmap package

median_subsidy_intensity_B_map <- effort_binned_med_sub_intensity %>%
  na.omit() %>%
  ggplot()+
  geom_tile(aes(x = lon_bin_center, y=lat_bin_center, fill = med_B_subs_KWh)) +
  geom_sf(data=world_land, color = NA, fill="grey30") +
  #geom_sf(data=eez_boundaries, color="grey80", size=0.1, aes(group = mrgid_eez)) +
  scale_fill_viridis_c(name="Median Subsidy Intensity ($/KWh)", limits = c(0,2), na.value = "#000000") +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), limits = c(-80,90))+
  xlab("") +
  ylab("") +
  theme(panel.background = element_rect(fill ="black"),
        plot.background = element_rect(fill = "black"),
        legend.background=element_rect(fill="black"),
        legend.text = element_text(color = "white", size = 16),
        legend.title = element_text(color = "white", size = 16),
        legend.title.align = 1,
        legend.direction="horizontal",
        legend.position = "bottom",
        legend.justification = "center",
        axis.text = element_text(color = "white", size = rel(1)),
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) +
 guides(fill=guide_legend(
                 keywidth=0.25,
                 keyheight=0.25,
                 default.unit="inch"))

ggsave(paste0(results_dir, "median_subsidy_intensity_B_map.png"), dpi = 200, width = 7, height = 5)

mean_subsidy_intensity_B_map <- effort_binned_mean_sub_intensity %>%
  na.omit() %>%
  ggplot()+
  geom_tile(aes(x = lon_bin_center, y=lat_bin_center, fill = mean_B_subs_KWh)) +
  geom_sf(data=world_land, color = NA, fill="grey30") +
  #geom_sf(data=eez_boundaries, color="grey80", size=0.1, aes(group = mrgid_eez)) +
  scale_fill_viridis_c(name="Median Subsidy Intensity ($/KWh)", limits = c(0,2), na.value = "#000000") +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), limits = c(-80,90))+
  xlab("") +
  ylab("") +
  theme(panel.background = element_rect(fill ="black"),
        plot.background = element_rect(fill = "black"),
        legend.background=element_rect(fill="black"),
        legend.text = element_text(color = "white", size = 16),
        legend.title = element_text(color = "white", size = 16),
        legend.title.align = 1,
        legend.direction="horizontal",
        legend.position = "bottom",
        legend.justification = "center",
        axis.text = element_text(color = "white", size = rel(1)),
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) +
 guides(fill=guide_legend(
                 keywidth=0.25,
                 keyheight=0.25,
                 default.unit="inch"))

ggsave(paste0(results_dir, "mean_subsidy_intensity_B_map.png"), dpi = 200, width = 7, height = 5)
```

Now we load the upsides database to get a measure of 
