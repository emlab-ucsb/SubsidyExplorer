---
output:
  html_document: default

title: "SubsidyExplorer - Step 0: Data Wrangling"
author: "Kat Millage, Vienna Saccomanno, Laura Lea Rubino, Christopher Costello"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 11pt
---

```{r}
# Packages
library(knitr) 
library(countrycode) # country name matching
library(here)
library(WDI) # World Bank GDP and population numbers by country
library(janitor) # cleaning column names
library(tidyverse)
library(readxl)

# Code chunk defaults
knitr::opts_chunk$set(echo = FALSE, error = FALSE, message = FALSE, warning = FALSE, include = FALSE)

# Source helper file
source(here::here("scripts", "00_helpers.R"))

# Directories for the output files generated by this script
data_dir <- here::here("data", "edited/")
if (dir.exists(data_dir) == F) {
  dir.create(data_dir, recursive = T)
}

app_data_dir <- here::here("app", "data/")
if (dir.exists(app_data_dir) == F) {
  dir.create(app_data_dir, recursive = T)
}

results_dir <- here::here("results", "01-data-wrangling/")
if (dir.exists(results_dir) == F) {
  dir.create(results_dir, recursive = T)
}
```

# Description

This script handles the preliminary data wrangling for the raw datasets underlying the SubsidyExplorer analysis. It outputs tidyed data files to `r data_dir`. Some of these tidied data files are used directly as input data by the SubsidyExplorer toolkit (saved to `r app_data_dir`). 

```{r}
# Paths to subsidies data files
sumaila_subsidies_path <- here::here("data", "raw", "Sumaila-et-al-2019-subsidies", "Subsidies_PEW_Final.xlsx")
oecd_fse_path <- here::here("data", "raw", "OECD-2019-fse", "FISH_FSE_10032020183349581.csv")

# Paths to demographic data files
fao_fishers_path <- here::here("data", "raw", "FAO-2019-yearbook", "fao_fishers_yearbook_070619.csv")
teh_fte_path <- here::here("data", "raw", "Teh-and-Sumaila-2013-fte", "Fisher employment FTE.xlsx")

# Paths to fisheries data files
fao_production_path <- here::here("data", "raw", "FAO-2019-capture-production", "TS_FI_CAPTURE.csv")
#fao_value_path
melnychuk_price_path <- here::here("data", "raw", "Melnychuk-et-al-2013-price", "Melnychuk_Exvessel_Price_Database.csv")

# Paths to fisheries mgmt files 
costello_upsides_path <- here::here("data", "raw", "Costello-et-al-2016-upsides", "ProjectionData_2012.csv")
melnychuk_fmi_path <- here::here("data", "raw", "Melnychuk-et-al-2017-fmi", "fmi_values_country.csv")
ram_sadb_path <- here::here("data", "raw", "RAM-2018-stock-assessment-database", "RLSADB v4.40", "DB Files With Assessment Data", "RLSADB v4.40 (assessment data only).xlsx")
anderson_fpi_path <- here::here("data", "raw", "Anderson-et-al-2015-fpi", "fpi_values_fishery.csv")

# Paths to other files
iuu_vessel_path <- here::here("data", "raw", "IUU-Vessel-List-2019", "IUUList-20190430.csv")
```

The following data sources are included in this analysis: 

**Subsidy Data**
Estimates of annual fisheries subsidies provision by state from Sumaila et al. (2019) in 2018 US\$. These data were provided to us directly by the authors as a .xlsx file and are stored at `r sumaila_subsidies_path`.
> Sumaila, U. R., Ebrahim, N., Schuhbauer, A., Skerritt, D., Li, Y., Kim, H. S., … Pauly, D. (2019). Updated estimates and analysis of global fisheries subsidies. Marine Policy, 109, 103695. https://doi.org/10.1016/j.marpol.2019.103695

Estimates of fisheries support provision by state from the OECD (2008 - 2018). These data were last downloaded from the OECD iLibrary portal as a CSV file on March 10, 2019 and are stored as `r oecd_fse_path`.
> OECD (2019), "Fisheries: Fisheries support estimates", OECD Agriculture Statistics (database), https://doi.org/10.1787/ade64fdc-en (accessed on 10 March 2019).

**Demographic Data**
Total GDP, GDP from fisheries, forestry, and agriculture, and population by state from the World Bank's World Development Indicators Database (2000 - 2018). These data were accessed through the `WDI` package. The code used to pull the data is below. 
> The World Bank (2019). "World Development Indicators", https://datacatalog.worldbank.org/dataset/world-development-indicators (accessed on 24 October 2019). 

Total number of fishers by state from the FAO Yearbook of Fishery and Aquaculture Statistics (misc. years between 1995 and 2017). These data were manually transcribed from PDF (`./data/raw/fleet_&_employment.pdf`) to CSV format on July 6, 2019 and are stored as `r fao_fishers_path`. 
> FAO (2019). FAO yearbook. Fishery and Aquaculture Statistics 2017, http://www.fao.org/fishery/statistics/global-fishers/en (accessed on 24 October 2019). 

Estimated number of full-time jobs in fisheries from Teh and Sumaila (2013) in 2003. These data were provided to us directly by the authors as a .xlsx file and are stored as `r teh_fte_path`. 
> Teh, L. C. L., & Sumaila, U. R. (2011). Contribution of marine fisheries to worldwide employment. Fish and Fisheries, 14(1), 77–88. https://doi.org/10.1111/j.1467-2979.2011.00450.x

**Fisheries Data**
Fisheries landings in 2017 from the FAO Global Capture Production database (2019) and estimates of landed value generated using the ex-vessel price database created by Melnychuk et al. (2017). These data were were wrangled in the previous script, and the edited data are stored as `r catch_dat_path`. 
> FAO (2019). FAO yearbook. Fishery and Aquaculture Statistics 2017, http://www.fao.org/fishery/statistics/global-capture-production/en (accessed on 24 October 2019). 

Estimated landed price 
> Melnychuk, M. C., Clavelle, T., Owashi, B., & Strauss, K. (2017). Reconstruction of global ex-vessel prices of fished species. ICES Journal of Marine Science, 74(1), 121–133. https://doi.org/10.1093/icesjms/fsw169

Stock status database
> Costello, C., Ovando, D., Clavelle, T., Strauss, C. K., Hilborn, R., Melnychuk, M. C., Branch, T. A., Gaines, S. D., Szuwalski, C. S., Cabral, R. B., Rader, D. N., & Leland, A. (2016). Global fishery prospects under contrasting management regimes. Proceedings of the National Academy of Sciences, 113(18), 5125–5129. https://doi.org/10.1073/pnas.1520420113

Fisheries management indicators
> Melnychuk, M. C., Peterson, E., Elliott, M., & Hilborn, R. (2017). Fisheries management impacts on target species status. Proceedings of the National Academy of Sciences, 114(1), 178–183. https://doi.org/10.1073/pnas.1609915114

RAM Stock assessment database
> RAM Legacy Stock Assessment Database. (2018). Version 4.44-assessment-only. Released 2018-12-22. DOI:10.5281/zenodo.2542919

Fisheries performance indicators
> Anderson, J. L., Anderson, C. M., Chu, J., Meredith, J., Asche, F., Sylvia, G., Smith, M. D., Anggraeni, D., Arthur, R., Guttormsen, A., McCluney, J. K., Ward, T., Akpalu, W., Eggert, H., Flores, J., Freeman, M. A., Holland, D. S., Knapp, G., Kobayashi, M., … Valderrama, D. (2015). The Fishery Performance Indicators: A Management Tool for Triple Bottom Line Outcomes. PLOS ONE, 10(5), e0122809. https://doi.org/10.1371/journal.pone.0122809

IUU Consolidated vessel list
> NEED

# Note: Political entities, dependencies, and naming

The naming of flag and coastal states varies widely across our data sources and we recognize that this can be a politially sensitive matter. For the purposes of merging multiple data sources, we therefore translate all state names from the raw data sources to ISO-3 character codes. Country names are only used for display purposes, and the use of any particular name is not meant to convey any options regarding sovereignty on behalf of the authors. 

```{r}
# Load country dependencies helper file
country_dependencies <- read_csv(here::here("data", "lookup-tables", "country_dependencies.csv"))

# EU countries
eu_countries <- country_dependencies$iso3[country_dependencies$is_EU]
eu_country_names <- sort(countrycode(eu_countries, "iso3c", "country.name"))

# EU overseas territories
eu_territories <- country_dependencies$iso3[country_dependencies$is_overseas_territory & country_dependencies$sovereign_iso3 %in% eu_countries]
eu_territory_names <- sort(c(countrycode(eu_territories, "iso3c", "country.name"), "Ascension Island", "Tristan da Cunha"))

# US overseas territories:  American Samoa, Guam, Northern Marianas Islands, Puerto Rico, US Virgin Islands
us_territories <- country_dependencies$iso3[country_dependencies$is_overseas_territory & country_dependencies$sovereign_iso3 == "USA"]
us_territory_names <- sort(countrycode(us_territories, "iso3c", "country.name"))

# Norwegian overseas territories: 
nor_territories <- country_dependencies$iso3[country_dependencies$is_overseas_territory & country_dependencies$sovereign_iso3 == "NOR"]
nor_territory_names <- sort(countrycode(nor_territories, "iso3c", "country.name"))
```

Additionally, it is important to note that the European Union as a political entity is a Member of the World Trade Organization, rather then the individual states that make up the European Union. We therefore need to create a profile for the European Union as a whole.  The following `r length(eu_country_names)` states are considered to be part of the European Union for the purposes of this analysis: `r paste(eu_country_names, collapse = ", ")`. 

The Netherlands, France, Denmark, and the United Kingdom also have overseas dependencies that should be considered to be a part of the European Union for statistical purposes. The following overseas dependencies are also considered to be a part of the European Union for the purpose of aggregating data in this analysis: `r paste(eu_territory_names, collapse = ", ")`.

Outside of the EU, the other dependencies we need to worry about are those that relate to the United States and Norway. The following overseas dependencies are considered to be a part of the United States for the purpose of aggregating data in this analysis: `r paste(us_territory_names, collapse = ", ")`. The following overseas dependencies are considered to be a part of Norway for the purpose of aggregating data in this analysis: `r paste(norway_territory_names, collapse = ", ")`. 

# Section 1 - Subsidies Data

## Updated estimates and analysis of global fisheries subsidies from Sumaila et al. (2019)

```{r}
### Data Wrangling
# Load and wrangle 2019 data
sumaila_2019_dat <- read_xlsx(sumaila_subsidies_path) %>%
  clean_names(case = "snake") %>%
  mutate(iso3 = case_when(country == "Dominican Rp" ~ "DOM",
                          country == "Micronesia" ~ "FSM",
                          country == "Untd Arab Em" ~ "ARE",
                          TRUE ~ countrycode(country, "country.name", "iso3c"))) %>%
  dplyr::select(iso3, type = class, data_type, value = constant_2018_usd) %>%
  mutate(year = 2018,
         units = "2018 US$",
         source = "Sumaila et al. (2019)") %>%
  arrange(iso3)

# Load lookup table for classification scheme
sumaila_lookup <- read_csv(here::here("data", "lookup-tables", "sumaila_subsidies_classification_lookup_table.csv"))

# Clean up the naming/spelling of the classification scheme as well as data type
sumaila_2019_dat_edit <- sumaila_2019_dat %>%
  left_join(sumaila_lookup, by = "type") %>%
  dplyr::select(iso3, year, category, category_name, type, type_name, value, data_type, units, source)

sumaila_2019_dat_edit$data_type[sumaila_2019_dat_edit$data_type == "not found evidence of subsidy"] <- "Found no evidence of subsidy"

# Deal with the EU
sumaila_2019_dat_eu <- sumaila_2019_dat_edit %>%
  dplyr::filter(iso3 %in% c(eu_countries, eu_territories)) %>%
  mutate(entity = "EU",
         data_type = "Aggregate") %>%
  group_by(entity, year, category, category_name, type, type_name, data_type, units, source) %>%
  summarize(value = sum(value, na.rm = T)) %>%
  rename(iso3 = entity)

# Add the EU back in
sumaila_2019_dat_edit <- sumaila_2019_dat_edit %>%
  bind_rows(sumaila_2019_dat_eu) %>%
  mutate(variable = "subsidies_Sumaila")

# Save
write_csv(sumaila_2019_dat_edit, paste0(data_dir, "sumaila_et_al_2019_subsidies_tidy.csv"))
write_csv(sumaila_2019_dat_edit, paste0(app_data_dir, "sumaila_et_al_2019_subsidies_tidy.csv"))

```

## Estimates of fisheries support provision by state from the OECD (2008 - 2018)

```{r}
# Load and wrangle OECD data (2009 - 2017)
oecd_fse_dat <- read_csv(oecd_fse_path) %>%
  clean_names(case = "snake") %>%
  dplyr::filter(measure == "USD", # only pull estimates in USD for consistancy
                country != "OECD") %>% # remove totals
  dplyr::select(iso3 = country, code = variable, year, value) 

# Load OECD lookup table
oecd_fse_lookup <- read_csv(here::here("data", "lookup-tables", "oecd_fse_classification_lookup_table.csv")) %>%
  distinct(category, category_name, type, type_code, type_name)

# Match based on type - that should be plenty for the figure on SubsidyExplorer
oecd_fse_dat_edit <- oecd_fse_dat %>%
  inner_join(oecd_fse_lookup, by = c("code" = "type_code")) %>%
  mutate(data_type = "Reported",
         units = paste0(year, " US$"),
         source = "OECD FSE database") %>%
  dplyr::select(iso3, year, category, category_name, type, type_name, data_type, units, source, value)

# Deal with the EU
oecd_fse_dat_eu <- oecd_fse_dat_edit %>%
  dplyr::filter(iso3 %in% c(eu_countries, eu_territories)) %>%
  mutate(entity = "EU",
         data_type = "Aggregate") %>%
  group_by(entity, year, category, category_name, type, type_name, data_type, units, source) %>%
  summarize(value = sum(value, na.rm = T)) %>%
  rename(iso3 = entity) %>%
  arrange(iso3, year, type)

# Add EU back in 
oecd_fse_dat_edit <- oecd_fse_dat_edit %>%
  bind_rows(oecd_fse_dat_eu) %>%
  mutate(variable = "subsidies_OECD")
  
# Save
write_csv(oecd_fse_dat_edit, paste0(data_dir, "oecd_2019_fse_tidy.csv"))
write_csv(oecd_fse_dat_edit, paste0(app_data_dir, "oecd_2019_fse_tidy.csv"))

```

# Section 2 - Demographic Data

## Demographic statistics by state from the World Bank's World Development Indicators Database (2000 - 2018)

```{r}
# Load data using WDI package
wb_demo_dat <- WDI(country = "all",
                   indicator = c("gdp" = "NY.GDP.MKTP.CD",
                                 "gdp_ffa" = "NV.AGR.TOTL.CD",
                                 "population" = "SP.POP.TOTL"),
                                  start = 2000,
                                  end = 2018,
                                  extra = TRUE) %>%
  dplyr::filter(region != "Aggregates") %>%
  dplyr::select(iso3 = iso3c,
                year,
                gdp,
                gdp_ffa,
                population) %>%
  mutate(iso3 = as.character(iso3)) %>%
  arrange(iso3, year) %>%
  gather(variable, value, c("gdp", "gdp_ffa", "population")) %>%
  dplyr::filter(!is.na(value)) %>%
  mutate(units = case_when(variable == "population" ~ "individuals",
                           TRUE ~ paste0(year, " US$")),
         source = "World Bank WDI database")

# Deal with the EU + territories
wb_dat_eu <- wb_demo_dat %>%
  dplyr::filter(iso3 %in% c(eu_countries, eu_territories)) %>%
  mutate(entity = "EU") %>%
  group_by(entity, year, variable, units, source) %>%
  summarize(value = sum(value, na.rm = T)) %>%
  rename(iso3 = entity) %>%
  arrange(iso3, year, variable)

# Deal with the US + territories
wb_dat_us <- wb_demo_dat %>%
  dplyr::filter(iso3 %in% c(us_territories, "USA")) %>%
  mutate(entity = "USA") %>%
  group_by(entity, year, variable, units, source) %>%
  summarize(value = sum(value, na.rm = T)) %>%
  rename(iso3 = entity) %>%
  arrange(iso3, year, variable)

# Add back in
wb_dat_edit <- wb_demo_dat %>%
  dplyr::filter(iso3 != "USA") %>%
  bind_rows(wb_dat_eu) %>%
  bind_rows(wb_dat_us)

# Export clean
write_csv(wb_dat_edit, paste0(data_dir, "world_bank_2020_wdi_tidy.csv"))
write_csv(wb_dat_edit, paste0(app_data_dir, "world_bank_2020_wdi_tidy.csv"))
```

## Total number of fishers by state from the FAO Yearbook of Fishery and Aquaculture Statistics (misc. years between 1995 and 2016)

```{r}
# Pull data and wrangle
fao_fishers_dat <- read_csv(fao_fishers_path) %>%
  mutate(iso3 = countrycode(country, "country.name", "iso3c")) %>%
  dplyr::select(-country) %>%
  gather(year, value, c('1995', '2000', '2005', '2010', '2011', '2012', '2013', '2014', '2015', '2016')) %>%
  mutate(year = as.numeric(year)) %>%
  dplyr::filter(!is.na(value)) %>%
  mutate(variable = "fishers",
         units = "individuals",
         source = "FAO Yearbook of Fishery and Aquaculture Statistics (2017)")

# Deal with EU
fao_fishers_dat_eu <- fao_fishers_dat %>%
  dplyr::filter(iso3 %in% c(eu_countries, eu_territories)) %>%
  mutate(entity = "EU") %>%
  group_by(entity, year, variable, units, source) %>%
  summarize(value = sum(value, na.rm = T)) %>%
  rename(iso3 = entity) %>%
  arrange(iso3, year, variable)

# Add EU back in 
fao_fishers_dat_edit <- fao_fishers_dat %>%
  bind_rows(fao_fishers_dat_eu) %>%
  arrange(year, iso3)

# Export clean
write_csv(fao_fishers_dat_edit, paste0(data_dir, "fao_2017_yearbook_fishers_tidy.csv"))
write_csv(fao_fishers_dat_edit, paste0(app_data_dir, "fao_2017_yearbook_fishers_tidy.csv"))
```

## Estimated number of full-time jobs in fisheries from Teh and Sumaila (2013) in 2003

```{r}
# Pull data and wrangle
teh_fte_dat <- read_xlsx(teh_fte_path) %>%
  clean_names(case = "snake") %>%
  mutate(iso3 = case_when(country == "Dominican Rp" ~ "DOM",
                          country == "Micronesia" ~ "FSM",
                          country == "Untd Arab Em" ~ "ARE",
                          TRUE ~ countrycode(country, "country.name", "iso3c"))) %>%
  dplyr::select(-country) %>%
  mutate(variable = "fishers_fte",
         year = 2003,
         units = "full-time equivalent jobs",
         source = "Teh and Sumaila (2013)") %>%
  dplyr::select(iso3, year, variable, value = total_fte, units, source)

# Deal with EU
teh_fte_dat_eu <- teh_fte_dat %>%
  dplyr::filter(iso3 %in% c(eu_countries, eu_territories)) %>%
  mutate(entity = "EU") %>%
  group_by(entity, year, variable, units, source) %>%
  summarize(value = sum(value, na.rm = T)) %>%
  rename(iso3 = entity) %>%
  arrange(iso3, year, variable)

# Add EU back in 
teh_fte_dat_edit <- teh_fte_dat %>%
  bind_rows(teh_fte_dat_eu)

# Export clean
write_csv(teh_fte_dat_edit, paste0(data_dir, "teh_and_sumaila_2013_fte_tidy.csv"))
write_csv(teh_fte_dat_edit, paste0(app_data_dir, "teh_and_sumaila_2013_fte_tidy.csv"))
```

# Section 3 - Fisheries Data

## Fisheries landings for 2000-2017 from the FAO Global Capture Production database (2019)

## Estimated landed price 

## Stock status database
```{r}
# Load data
costello_upsides_dat <- read_csv(costello_upsides_path) %>%
  clean_names(case = "snake")

# We need to split the entries that span multiple FAO regions...  
costello_upsides_dat_edit <- costello_upsides_dat %>%
  mutate(region_fao_chr = as.character(region_fao),
         n_regions = nchar(region_fao_chr)/2,
         region_fao_split = str_split(gsub("(.{2})", "\\1 ", region_fao_chr), " ")) %>%
  unnest(cols = c(region_fao_split)) %>%
  mutate(region_fao_split = as.numeric(region_fao_split)) %>%
  dplyr::filter(region_fao_split != "") %>%
  mutate(iso3 = case_when(country == "Channel Islands" ~ "JEY",
                          country == "Micronesia" ~ "FSM",
                          country == "Zanzibar" ~ "TZA",
                          TRUE ~ countrycode(country, "country.name", "iso3c")))

# Save clean
write_csv(costello_upsides_dat_edit, paste0(data_dir, "costello_et_al_2016_upsides_tidy.csv"))

```

# Melnychuk FMI
```{r}
# Load data and wrangle
melnychuk_fmi_dat <- read_csv(melnychuk_fmi_path) %>%
  clean_names(case = "snake") %>%
  mutate(iso3 = countrycode(country, "country.name", "iso3c")) %>%
  dplyr::select(-country) %>%
  gather(variable, value, -iso3)

# Create a mean aggregate for the EU
melnychuk_fmi_dat_eu <- melnychuk_fmi_dat  %>%
  dplyr::filter(iso3 %in% c(eu_countries, eu_territories)) %>%
  mutate(entity = "EU") %>%
  group_by(entity, variable) %>%
  summarize(value = mean(value, na.rm = T)) %>%
  rename(iso3 = entity)

# Add EU back in
melnychuk_fmi_dat_edit <- melnychuk_fmi_dat %>%
  bind_rows(melnychuk_fmi_dat_eu)

# Export clean
write_csv(melnychuk_fmi_dat_edit, paste0(data_dir, "melnychuk_et_al_2017_fmi_tidy.csv"))

```

