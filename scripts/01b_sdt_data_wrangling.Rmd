---
output:
  html_document: default

title: "SubsidyExplorer - Additional data wrangling pertaining to proposal S&DT"
author: "Kat Millage, Vienna Saccomanno, Laura Lea Rubino, Christopher Costello"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 11pt
---

```{r}
# Packages
library(knitr) # Necessary to convert file to .html
library(countrycode) # Country name matching
library(here) # File path handling
#remotes::install_github('vincentarelbundock/WDI')
library(WDI) # World Bank World Development Indicators data
library(janitor) # Column name handling
library(tidyverse) # General data wrangling
library(readxl) # Load .xlsx files

# Code chunk defaults
knitr::opts_chunk$set(echo = FALSE, error = FALSE, message = FALSE, warning = FALSE, include = FALSE)

# Source file with helper functions (used throughout analysis)
source(here::here("scripts", "00_helpers.R"))

# Directories for the output files generated by this script
data_dir <- here::here("data", "edited/")
if (dir.exists(data_dir) == F) {
  dir.create(data_dir, recursive = T)
}

app_data_dir <- here::here("app", "data/")
if (dir.exists(app_data_dir) == F) {
  dir.create(app_data_dir, recursive = T)
}

results_dir <- here::here("results", "01-data-wrangling/")
if (dir.exists(results_dir) == F) {
  dir.create(results_dir, recursive = T)
}
```

# Description

This script handles some additional data wrangling for the SubsidyExplorer analysis, specifically relating to proposed S&DT criteria from some of the proposals. It outputs tidied data files to `r data_dir`. Some of these tidied data files are used directly as input data by the SubsidyExplorer toolkit (saved to `r app_data_dir`). 

```{r}
country_lookup_path <- here::here("data", "lookup-tables", "country_dependencies.csv")
```

The following data sources are used: 

**Demographic Data**
GDP from fisheries, forestry, and agriculture, and GNI per capita from the World Bank's World Development Indicators Database (2000 - 2018). These data were accessed through the `WDI` package. The code used to pull the data is below. 
> World Bank. (2020). World Development Indicators. https://data.worldbank.org/

We also use our vessel list and definition of distant water fishing (described in other scripts) to identify countries fulfiling that criteria. 

```{r}
# Load country dependencies helper file
country_dependencies <- read_csv(country_lookup_path)

# Get all overseas dependencies that are relevant for the WTO - there are 49
territories <- country_dependencies %>%
  dplyr::filter(is_overseas_territory & is_WTO) %>%
  distinct(iso3, sovereign_iso3)

# Get all cooresponding sovereign states (we need to make sure any totals for these states include their dependencies) - there are 9
# Australia, Denmark, France, United Kingdom, Morocco, Netherlands, Norway, New Zealand, and the United States
sovereigns_with_territories <- territories %>%
  distinct(sovereign_iso3)

# EU countries
eu_countries <- country_dependencies$iso3[country_dependencies$is_EU]

# EU overseas territories
eu_territories <- country_dependencies$iso3[country_dependencies$is_overseas_territory & country_dependencies$sovereign_iso3 %in% eu_countries]
```

# S&DT Criteria 

Some proposals advocate for allowing developing countries to provide certain types of subsidies unless they meet certain criteria for three consecutive years: 
- GNI per capita is greater than \$5000 (constant 2015 US\$);
- they engage in distant water fishing;
- the contribution from Agriculture, Forestry and Fishing to their national GDP is greater than 10%.

```{r}
#Load data using WDI package
wb_sdt_dat <- WDI(country = "all",
                   indicator = c("gdp_ffa_percent" = "NV.AGR.TOTL.ZS", # Added value coming from fisheries, forestry, and agriculture (%)
                                 "gni_per_capita" = "NY.GNP.PCAP.KD"), # GNI per capita (constant 2015 US$)
                                  start = 2016,
                                  end = 2018,
                                  extra = TRUE) %>%
  dplyr::filter(region != "Aggregates") %>%
  dplyr::select(iso3 = iso3c,
                year,
                gdp_ffa_percent,
                gni_per_capita) %>%
  mutate(iso3 = as.character(iso3)) %>%
  arrange(iso3, year) %>%
  group_by(iso3) %>%
  mutate(n_exceeds_gdp_ffa = sum(gdp_ffa_percent > 10),
         n_exceeds_gni_per_capita = sum(gni_per_capita > 5000)) %>%
  ungroup() 
  
wb_sdt_dat_out <- wb_sdt_dat %>%
  distinct(iso3, n_exceeds_gdp_ffa, n_exceeds_gni_per_capita) %>%
  mutate(exceeds_gdp_ffa = case_when(n_exceeds_gdp_ffa == 3 ~ T,
                                     is.na(n_exceeds_gdp_ffa) ~ F,
                                     TRUE ~ F),
         exceeds_gni_per_capita = case_when(n_exceeds_gni_per_capita == 3 ~ T,
                                            is.na(n_exceeds_gni_per_capita) ~ F,
                                            TRUE ~ F)) %>%
  dplyr::select(-n_exceeds_gdp_ffa, -n_exceeds_gni_per_capita)

```

```{r}
# Load vessel list
vessel_dat <- read.csv(here::here("app", "data", "vessel_list_2018_final.csv"), stringsAsFactors = F)

# Create high seas code
vessel_dat <- vessel_dat %>%
  mutate(eez_hs_code = case_when(eez_id == 0 ~ paste0("HS-", fao_region),
                                 TRUE ~ as.character(eez_id)))

# Get flag states that participate in distant water fishing
vessel_dat_dw <- vessel_dat %>%
  distinct(flag_iso3, distant_water) %>%
  dplyr::filter(distant_water == T)
```

```{r}
sdt_dat_out <- wb_sdt_dat_out %>%
  left_join(vessel_dat_dw, by = c("iso3" = "flag_iso3")) %>%
  mutate(distant_water = ifelse(is.na(distant_water), FALSE, distant_water)) %>%
  mutate(meets_any_criteria = ifelse(exceeds_gdp_ffa | exceeds_gni_per_capita | distant_water, T, F))

write_csv(sdt_dat_out, paste0(data_dir, "sdt_lookup_table.csv"))
write_csv(sdt_dat_out, paste0(app_data_dir, "sdt_lookup_table.csv"))
```

