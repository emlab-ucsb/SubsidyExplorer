---
output:
  html_document: default

title: "SubsidyExplorer - Step 3: Classify vessels into management regimes"
author: "Kat Millage, Vienna Saccomanno, Laura Lea Rubino, Christopher Costello"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 11pt
bibliography: "../pew-subsidies.bib"

---

# Introduction

The purpose of this script is to classify all of our vessels into three different management regimes: 
- Managed
- Intermediate
- Open access

This script outputs a single data file to `r here::here("results", "03-management")`: 
- vessel-list-2018-management.csv

In addition to the vessel list created in the previous script, the following data sources are used to classify management regimes: 

```{r}
# General
library(knitr) 
library(countrycode) # country name matching
library(janitor)
library(tidyverse)

# Path to vessel list
vessel_list_path <- here::here("results", "1-vessel-list", "vessel-list-2018-raw.csv")

# Path to Management data
melnychuk_2017_mgmt_dat_path <- here::here("data", "raw", "management", "Melnychuk_2017", "fmi_values_country.csv" )

# Make figures?
make_plots <- T

# Few more packages if you're making figures
if(make_plots){
  library(ggridges)
  library(ggrepel)
  library(scales)
}
```

```{r}
# Code options
knitr::opts_chunk$set(echo = FALSE, error = FALSE, message = FALSE, warning = F)

# Directories for the output files generated by this script
results_dir <- here::here("results", "2-management/")
if (dir.exists(results_dir) == F) {
  dir.create(results_dir, recursive = T)
}

```

# Assign regions to vessels

```{r}
# Load vessel list
vessel_list_raw <- read.csv(vessel_list_path, stringsAsFactors = F)

```


# Match fishing areas to management indices

```{r setup, include=FALSE}
# Load management indicies by state
melnychuk_2017_mgmt_dat <- read_csv(melnychuk_2017_mgmt_dat_path) %>%
  clean_names(case = "snake") %>%
  mutate(iso3 = countrycode(country, "country.name", "iso3c")) %>%
  dplyr::select(iso3, fmi_weighted)

# Get eez codes and matching territories
eez_info <- vessel_list_raw %>%
  group_by(eez_id) %>%
  distinct(territory1_iso3, territory2_iso3, territory3_iso3, sovereign1_iso3, sovereign2_iso3, sovereign3_iso3) 

# Tidy eez data
eez_info_tidy <- eez_info %>%
  mutate(states = case_when((is.na(territory2_iso3) & is.na(territory3_iso3)) ~ 1,
                            (!is.na(territory2_iso3) & is.na(territory3_iso3)) ~ 2,
                            TRUE ~ 3)) %>%
  mutate(territory_iso = case_when(states == 1 ~ c(territory1_iso3),
                                   states == 2 ~ paste(territory1_iso3, territory2_iso3, sep = " "),
                                   states == 3 ~ paste(territory1_iso3, territory2_iso3, territory3_iso3, sep = " ")),
         sovereign_iso = case_when(states == 1 ~ c(sovereign1_iso3),
                                   states == 2 ~ paste(sovereign1_iso3, sovereign2_iso3, sep = " "),
                                   states == 3 ~ paste(sovereign1_iso3, sovereign2_iso3, sovereign3_iso3, sep = " "))) %>%
  dplyr::select(eez_id, territory_iso, sovereign_iso) %>%
  mutate(territory_split = map(territory_iso, ~ str_split(.x, " ")[[1]]),
         sovereign_split = map(sovereign_iso, ~ str_split(.x, " ")[[1]])) %>%
  unnest(cols = c(territory_split, sovereign_split)) %>%
  dplyr::select(eez_id, territory_iso3 = territory_split, sovereign_iso3 = sovereign_split)

eez_info_tidy$sovereign_iso3[eez_info_tidy$eez_id == 49003] <- "CHN"
```

```{r}
# EU countries
#Belgium, Bulgaria, Croatia, Cyprus, Denmark, Estonia, Finland, France, Germany, Greece, Ireland, Italy, Latvia, Lithuania, Malta, Netherlands, Poland, Portugal, Romania, Slovenia, Spain, Sweden, United Kingdom
eu_countries <- c("BEL", "BGR", "HRV", "CYP", "DNK", "EST", "FIN", "FRA", "DEU", "GRC", "IRL", "ITA", "LVA", "LTU", "MLT", "NLD", "POL", "PRT", "ROU", "SVN", "ESP", "SWE", "GBR")

# Dutch overseas territories: Aruba, Bonaire/St. Eustatius/Saba, Curacao, Sint Maarten
dutch_territories <- c("ABW", "BES", "CUW", "SXM")

# French overseas territories: French Guiana, French Polynesia, French Southern and Antarctic Territories, Guadeloupe, Martinique, Mayotte, New Caledonia, Reunion, Saint Barthelemy, Saint Martin, St. Pierre and Miquelon, Wallis and Futuna Islands
french_territories <- c("GUF", "PYF", "ATF", "GLP", "MTQ", "MYT", "NCL", "REU", "BLM", "MAF", "SPM", "WLF")

# Danish overseas territories: Faroe Islands, Greenland
danish_territories <- c("FRO", "GRL")

# British overseas territories: Anguilla, Ascension island, Bermuda, Cayman Islands, Falkland Islands, Guernsey, Gibraltar, British Indian Ocean Territories, Jersey, Monserratt, Pitcairn Island, South Georgia and the South Sandwich Islands, Saint Helena/Ascension/Tristan da Cunha, Tristan da Cunha, Turks and Caicos Islands, British Virgin Islands
uk_territories <- c("AIA","ASC","BMU","CYM","FLK","GGY","GIB","IOT","JEY","MSR","PCN","SGS","SHN","TAA","TCA","VGB")

eu_territories <- c(dutch_territories, french_territories, danish_territories, uk_territories)

# Norwegian overseas territories: Bouvet Islands, Svalbard and Jan Mayen Islands
norwegian_territories <- c("BVT", "SJM")

# US overseas territories:  American Samoa, Guam, Northern Marianas Islands, Puerto Rico, US Virgin Islands
us_territories <- c("ASM", "GUM", "MNP", "PRI", "VIR")
```

```{r}
# Get mean management indices for the EU, as well as by region 
regional_management_indices <- melnychuk_2017_mgmt_dat %>%
  mutate(region = countrycode(iso3, "iso3c", "region")) %>%
  group_by(region) %>%
  summarize(fmi_weighted_region = mean(fmi_weighted))

# Get EU avg management index
eu_management_index <- melnychuk_2017_mgmt_dat %>%
  dplyr::filter(iso3 %in% c(eu_countries, eu_territories)) %>%
  summarize(fmi_weighted_eu = mean(fmi_weighted))

eu_df <- tibble(iso3 = c(eu_countries, eu_territories), fmi_weighted_eu = eu_management_index$fmi_weighted_eu)

# Get continent averages 
continent_management_indices <- melnychuk_2017_mgmt_dat %>%
  mutate(continent = countrycode(iso3, "iso3c", "continent")) %>%
  group_by(continent) %>%
  summarize(fmi_weighted_continent = mean(fmi_weighted))

# Assign management indices to each EEZ
eez_management_indices <- eez_info_tidy %>%
  mutate(territory_region = countrycode(territory_iso3, "iso3c", "region"),
         sovereign_region = countrycode(sovereign_iso3, "iso3c", "region"),
         continent = countrycode(territory_iso3, "iso3c", "continent")) %>%
  left_join(melnychuk_2017_mgmt_dat, by = c("sovereign_iso3" = "iso3")) %>%
  left_join(eu_df, by = c("territory_iso3" = "iso3")) %>%
  left_join(regional_management_indices, by = c("territory_region" = "region")) %>%
  rename(fmi_weighted_region_territory = fmi_weighted_region) %>%
  left_join(regional_management_indices, by = c("sovereign_region" = "region")) %>%
  rename(fmi_weighted_region_sovereign = fmi_weighted_region) %>%
  left_join(continent_management_indices, by = c("continent")) %>%
  mutate(fmi_best = case_when(!is.na(fmi_weighted) ~ fmi_weighted,
                              !is.na(fmi_weighted_eu) ~ fmi_weighted_eu,
                              !is.na(fmi_weighted_region_territory) ~ fmi_weighted_region_territory,
                              !is.na(fmi_weighted_region_sovereign) ~ fmi_weighted_region_sovereign,
                              !is.na(fmi_weighted_continent) ~ fmi_weighted_continent,
                              TRUE ~ min(melnychuk_2017_mgmt_dat$fmi_weighted))) %>%
  group_by(eez_id) %>%
  summarize(fmi_best = mean(fmi_best)) %>%
  ungroup()

# Plot distribution by region curiousity
# ggplot(eez_management_indices, aes(x = fmi_best, y = territory_region, group = territory_region)) +
#   geom_density_ridges2()
# 
# ggplot(eez_management_indices, aes(x = fmi_best, y = continent, group = continent)) +
#   geom_density_ridges2()
```

# Apply management indices to vessels

```{r}
vessel_list_manage <- vessel_list_raw %>%
  left_join((eez_management_indices %>% dplyr::select(eez_id, fmi_best)), by = c("eez_id"))

management_quantile <- quantile(vessel_list_manage$fmi_best)
managed <- management_quantile["75%"]
openaccess <- management_quantile["25%"]

write_csv(vessel_list_manage, paste0(results_dir, "vessel-list-2018-management.csv"))
```


# Summary plots

## Average FMI by flag/fao region compared to total subsidy provision

```{r}
# FMI by flag from vessel list
fmi_flag_fao <- vessel_list_manage %>%
  group_by(flag) %>%
  mutate(tot_bad_subs = sum(bad_subs),
         tot_fuel_subs = sum(B7_subs)) %>%
  ungroup() %>%
  group_by(flag, fao_region) %>%
  summarize(fmi_weighted_avg = weighted.mean(fmi_best, catch),
            tot_bad_subs = unique(tot_bad_subs),
            tot_fuel_subs = unique(tot_fuel_subs))

ggplot(fmi_flag_fao)+
  aes(x = tot_bad_subs, y = fmi_weighted_avg)+
  geom_point()+
  theme_linedraw()+
  labs(x = "Total capacity-enhancing subsidies (2018 $US)",
       y = "Mean Weighted FMI")+
  scale_y_continuous(limits = c(0,1))+
  scale_x_continuous(labels = comma)
```


```{r}
# FMI by flag from vessel list
fmi_flag <- vessel_list_manage %>%
  group_by(flag) %>%
  mutate(tot_bad_subs = sum(bad_subs),
         tot_fuel_subs = sum(B7_subs)) %>%
  ungroup() %>%
  group_by(flag) %>%
  summarize(fmi_weighted_avg = weighted.mean(fmi_best, catch),
            tot_bad_subs = unique(tot_bad_subs),
            tot_fuel_subs = unique(tot_fuel_subs))

ggplot(fmi_flag)+
  aes(x = tot_bad_subs, y = fmi_weighted_avg)+
  geom_point()+
  theme_linedraw()+
  labs(x = "Total capacity-enhancing subsidies (2018 $US)",
       y = "Mean Weighted FMI")+
  scale_y_continuous(limits = c(0,1))+
  scale_x_continuous(labels = comma)
```

```{r}
countries_to_highlight <- c("CHN", "USA", "IDN", "JPN", "ISL", "THA")
  
# FMI by just from Melnychuk et al
fmi_flag_melnychuk_only <- vessel_list_manage %>%
  group_by(flag) %>%
  summarize(tot_bad_subs = sum(bad_subs),
         tot_fuel_subs = sum(B7_subs),
         tot_landings = sum(catch)) %>%
  right_join(melnychuk_2017_mgmt_dat, by = c("flag" = "iso3")) %>%
  mutate(display_name = case_when(flag %in% countries_to_highlight ~ countrycode(flag, "iso3c", "country.name")))

# plot
ggplot(fmi_flag_melnychuk_only)+
  aes(x = tot_bad_subs/1e6, y = fmi_weighted, size = tot_landings/1e6, color = display_name)+
  geom_point()+
  geom_text_repel(aes(label = display_name), size = 4, force = 100, point.padding = 0.25, box.padding = 1)+
  theme_linedraw()+
  labs(x = "Total capacity-enhancing subsidies (million 2018 $US)",
       y = "Weighted FMI")+
  scale_y_continuous(limits = c(0,1))+
  scale_x_continuous(labels = comma)+
  scale_size(range = c(2,8), breaks = c(5,10,15), limits = c(0,15), name = "Marine Capture Production (million mt, 2017)")+
  theme(legend.position = "top")+
  scale_color_discrete(guide = "none")

ggsave(paste0(results_dir, "fmi_flag_melnychuk_allbad.png"), width = 7, height = 4.5, units = "in")
```

```{r}
# Plot fuel subsidies only 
ggplot(fmi_flag_melnychuk_only)+
  aes(x = tot_fuel_subs/1e6, y = fmi_weighted, size = tot_landings/1e6, color = display_name)+
  geom_point()+
  geom_text_repel(aes(label = display_name), size = 4, force = 100, point.padding = 0.25, box.padding = 1)+
  theme_linedraw()+
  labs(x = "Total fuel subsidies (million 2018 $US)",
       y = "Weighted FMI")+
  scale_y_continuous(limits = c(0,1))+
  scale_x_continuous(labels = comma)+
  scale_size(range = c(2,8), breaks = c(5,10,15), limits = c(0,15), name = "Marine Capture Production (million mt, 2017)")+
  theme(legend.position = "top")+
  scale_color_discrete(guide = "none")

ggsave(paste0(results_dir, "fmi_flag_melnychuk_fuel.png"), width = 7, height = 4.5, units = "in")
```


```{r}
# For later use, get fraction of catch in each region from catch share fisheries, vs. not
# costello_catch_share_frac <- costello_2016_dat_edit %>%
#   group_by(region, catch_share) %>%
#   summarize(landings = sum(catch_new, na.rm = T)) %>%
#   ungroup() %>%
#   group_by(region) %>%
#   mutate(tot_landings = sum(landings, na.rm = T)) %>%
#   ungroup() %>%
#   mutate(frac_landings = landings/tot_landings) %>%
#   arrange(region)
```