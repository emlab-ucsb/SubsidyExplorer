---
output:
  html_document: default

title: "SubsidyExplorer - Step 3: Classify vessels into management regimes"
author: "Kat Millage, Vienna Saccomanno, Laura Lea Rubino, Christopher Costello"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 11pt
bibliography: "../pew-subsidies.bib"

---

# Introduction

The purpose of this script is to assign management scores to all of our vessels, such that they can later be classified into three different management regimes: 
- Well-managed
- Managed
- Open access

This script outputs a single data file to `r here::here("results", "03-management")`: 
- vessel-list-2018-management.csv

```{r}
# General
library(knitr) 
library(countrycode) # country name matching
library(janitor)
library(tidyverse)

# Path to vessel list
vessel_list_path <- here::here("results", "02-vessel-list", "vessel_list_2018_raw.csv")

# Path to Melnychuk FMI data
melnychuk_2017_mgmt_dat_path <- here::here("data", "edited", "melnychuk_et_al_2017_fmi_tidy.csv" )

# Path to Costello upsides data
costello_2016_upsides_dat_path <- here::here("data", "edited", "costello_et_al_2016_upsides_tidy.csv")

# Make figures?
make_plots <- F

# Few more packages if you're making figures
if(make_plots){
  library(ggridges)
  library(ggrepel)
  library(scales)
}
```

```{r}
# Code options
knitr::opts_chunk$set(echo = FALSE, error = FALSE, message = FALSE, warning = F)

# Directories for the output files generated by this script
results_dir <- here::here("results", "03-management/")
if (dir.exists(results_dir) == F) {
  dir.create(results_dir, recursive = T)
}

```

# Get EEZ info from vessel list

```{r}
# Load vessel list
vessel_list_raw <- read.csv(vessel_list_path, stringsAsFactors = F)

```

```{r}
# Get eez codes and cooresponding territories/sovereigns
eez_info <- vessel_list_raw %>%
  group_by(eez_id) %>%
  distinct(eez_territory1_iso3, eez_territory2_iso3, eez_territory3_iso3, eez_sovereign1_iso3, eez_sovereign2_iso3, eez_sovereign3_iso3) 

# Tidy eez data
eez_info_tidy <- eez_info %>%
  mutate(n_states = case_when((is.na(eez_territory2_iso3) & is.na(eez_territory3_iso3)) ~ 1,
                            (!is.na(eez_territory2_iso3) & is.na(eez_territory3_iso3)) ~ 2,
                            TRUE ~ 3)) %>%
  mutate(eez_territory_iso3 = case_when(n_states == 1 ~ c(eez_territory1_iso3),
                                   n_states == 2 ~ paste(eez_territory1_iso3, eez_territory2_iso3, sep = " "),
                                   n_states == 3 ~ paste(eez_territory1_iso3, eez_territory2_iso3, eez_territory3_iso3, sep = " ")),
         eez_sovereign_iso3 = case_when(n_states == 1 ~ c(eez_sovereign1_iso3),
                                   n_states == 2 ~ paste(eez_sovereign1_iso3, eez_sovereign2_iso3, sep = " "),
                                   n_states == 3 ~ paste(eez_sovereign1_iso3, eez_sovereign2_iso3, eez_sovereign3_iso3, sep = " "))) %>%
  dplyr::select(eez_id, eez_territory_iso3, eez_sovereign_iso3) %>%
  mutate(territory_split = map(eez_territory_iso3, ~ str_split(.x, " ")[[1]]),
         sovereign_split = map(eez_sovereign_iso3, ~ str_split(.x, " ")[[1]])) %>%
  unnest(cols = c(territory_split, sovereign_split)) %>%
  dplyr::select(eez_id, eez_territory_iso3 = territory_split, eez_sovereign_iso3 = sovereign_split)

eez_info_tidy$eez_sovereign_iso3[eez_info_tidy$eez_id == 49003] <- "CHN"
```

# Management Scores from FMI indices

## Assign FMI indicies to regions

```{r setup, include=FALSE}
# Load management indicies by state
melnychuk_2017_mgmt_dat <- read_csv(melnychuk_2017_mgmt_dat_path) %>%
  dplyr::filter(variable == "fmi_weighted")

# Load country lookup
country_dependencies <- read_csv(here::here("data", "lookup-tables", "country_dependencies.csv"))

# EU countries
eu_countries <- country_dependencies$iso3[country_dependencies$is_EU]
eu_territories <- country_dependencies$iso3[country_dependencies$sovereign_iso3 %in% eu_countries & country_dependencies$is_overseas_territory]
```

```{r}
# Get mean management indices for the EU, as well as by region 
regional_management_indices <- melnychuk_2017_mgmt_dat %>%
  mutate(region = countrycode(iso3, "iso3c", "region")) %>%
  group_by(region) %>%
  summarize(fmi_weighted_region = mean(value)) %>%
  na.omit()

# Get EU avg management index
eu_management_index <- melnychuk_2017_mgmt_dat %>%
  dplyr::filter(iso3 == "EU")

eu_df <- tibble(iso3 = c(eu_countries, eu_territories), fmi_weighted_eu = eu_management_index$value)

# Get continent averages 
continent_management_indices <- melnychuk_2017_mgmt_dat %>%
  mutate(continent = countrycode(iso3, "iso3c", "continent")) %>%
  group_by(continent) %>%
  summarize(fmi_weighted_continent = mean(value)) %>%
  na.omit()

# Assign management indices to each EEZ
eez_management_indices <- eez_info_tidy %>%
  arrange(eez_sovereign_iso3) %>%
  mutate(eez_territory_region = countrycode(eez_territory_iso3, "iso3c", "region"),
         eez_sovereign_region = countrycode(eez_sovereign_iso3, "iso3c", "region"),
         eez_continent = countrycode(eez_territory_iso3, "iso3c", "continent")) %>%
  left_join(melnychuk_2017_mgmt_dat, by = c("eez_sovereign_iso3" = "iso3")) %>%
  rename(fmi_weighted = value) %>%
  dplyr::select(-variable) %>%
  left_join(eu_df, by = c("eez_territory_iso3" = "iso3")) %>%
  left_join(regional_management_indices, by = c("eez_territory_region" = "region")) %>%
  rename(fmi_weighted_region_territory = fmi_weighted_region) %>%
  left_join(regional_management_indices, by = c("eez_sovereign_region" = "region")) %>%
  rename(fmi_weighted_region_sovereign = fmi_weighted_region) %>%
  left_join(continent_management_indices, by = c("eez_continent" = "continent")) %>%
  mutate(fmi_best = case_when(!is.na(fmi_weighted) ~ fmi_weighted,
                              !is.na(fmi_weighted_eu) ~ fmi_weighted_eu,
                              !is.na(fmi_weighted_region_territory) ~ fmi_weighted_region_territory,
                              !is.na(fmi_weighted_region_sovereign) ~ fmi_weighted_region_sovereign,
                              !is.na(fmi_weighted_continent) ~ fmi_weighted_continent,
                              TRUE ~ min(melnychuk_2017_mgmt_dat$value))) %>%
  group_by(eez_id) %>%
  summarize(fmi_best = mean(fmi_best)) %>% # Necessary for disputed areas/joint regime areas
  ungroup()

```

# Median fishing pressure by FAO region

```{r}
# Load costello stock status database
costello_2016_upsides_dat <- read_csv(costello_2016_upsides_dat_path)

# Median F/Fmsy by FAO region
median_fvfmsy_fao <- costello_2016_upsides_dat %>%
  group_by(region_fao_split) %>%
  summarize(fvfmsy_med_region = median(fv_fmsy, na.rm = T),
            fvfmsy_mean_region = mean(fv_fmsy, na.rm = T),
            fvfmsy_w_mean_region = weighted.mean(fv_fmsy, w = msy, na.rm = T)) %>%
  dplyr::select(fao_region = region_fao_split, fvfmsy_med_region)
```

# Median fishing pressure by FAO region and state

```{r}
# median_fvfmsy_fao_flag <- costello_2016_upsides_dat %>%
#   group_by(iso3, region_fao_split) %>%
#   summarize(fvfmsy_med_eez = median(fv_fmsy, na.rm = T),
#             fvfmsy_mean_eez = mean(fv_fmsy, na.rm = T),
#             fvfmsy_w_mean_eez = weighted.mean(fv_fmsy, w = msy, na.rm = T)) %>%
#   dplyr::select(iso3, fao_region = region_fao_split, fvfmsy_med_eez)
```

# Proportion of formally assessed stocks by FAO region

In order to include flag state, we would need to fix this one - How to treat "multinational" stocks. These should be attributed to all flag states that are fishing in those fisheries.  

```{r}
prop_assessed_stocks <- costello_2016_upsides_dat %>%
  group_by(region_fao_split) %>%
  summarize(catch_ram = sum(catch[dbase == "RAM"]),
            catch_other = sum(catch[dbase != "RAM"])) %>%
  mutate(catch_prop_ram = catch_ram/(catch_ram + catch_other)) %>%
  dplyr::select(fao_region = region_fao_split, catch_prop_ram)
```

# Proportion of catch share stocks by FAO region

```{r}
prop_catch_share_stocks <- costello_2016_upsides_dat %>%
  group_by(region_fao_split) %>%
  summarize(catch_share= sum(catch[catch_share == 1]),
            catch_other = sum(catch[catch_share != 1])) %>%
  mutate(catch_prop_cs= catch_share/(catch_share + catch_other)) %>%
  dplyr::select(fao_region = region_fao_split, catch_prop_cs)
```

# Apply management indices to vessels

```{r}
vessel_list_manage <- vessel_list_raw %>%
  left_join(eez_management_indices, by = c("eez_id")) %>%
  left_join(median_fvfmsy_fao, by = c("fao_region")) %>%
  left_join(prop_assessed_stocks, by = c("fao_region")) %>%
  left_join(prop_catch_share_stocks, by = c("fao_region"))

# FAO region 18 is missing stock data, but has some effort
vessel_list_manage$fvfmsy_med_region[is.na(vessel_list_manage$fvfmsy_med_region)] <- 1
vessel_list_manage$catch_prop_ram[is.na(vessel_list_manage$catch_prop_ram)] <- 0
vessel_list_manage$catch_prop_cs[is.na(vessel_list_manage$catch_prop_cs)] <- 0

write_csv(vessel_list_manage, paste0(results_dir, "vessel_list_2018_management.csv"))

# Calculate management quantiles for each indicator
fmi_quantile <- tibble("indicator" = "fmi") %>%
  bind_cols(setNames(as.data.frame(matrix(quantile(vessel_list_manage$fmi_best), nrow = 1)), names(quantile(vessel_list_manage$fmi_best))))

fvfmsy_quantile <- tibble("indicator" = "fvfmsy") %>%
  bind_cols(setNames(as.data.frame(matrix(quantile(vessel_list_manage$fvfmsy_med_region), nrow = 1)), names(quantile(vessel_list_manage$fvfmsy_med_region))))

catch_ram_quantile <- tibble("indicator" = "catch_prop_ram") %>%
  bind_cols(setNames(as.data.frame(matrix(quantile(vessel_list_manage$catch_prop_ram), nrow = 1)), names(quantile(vessel_list_manage$catch_prop_ram))))

catch_cs_quantile <- tibble("indicator" = "catch_prop_cs") %>%
  bind_cols(setNames(as.data.frame(matrix(quantile(vessel_list_manage$catch_prop_cs), nrow = 1)), names(quantile(vessel_list_manage$catch_prop_cs))))

indicator_quantiles <- fmi_quantile %>%
  bind_rows(fvfmsy_quantile) %>%
  bind_rows(catch_ram_quantile) %>%
  bind_rows(catch_cs_quantile)

write_csv(indicator_quantiles, paste0(results_dir, "management_indicator_quantiles.csv"))
```

# Summary plots

## Coorelation between average FMI by flag/fao region and subsidy provisioning

```{r}
if(make_plots){
  
# FMI by flag and FAO from vessel list
fmi_flag_fao <- vessel_list_manage %>%
  group_by(flag) %>%
  mutate(tot_bad_subs = sum(bad_subs),
         tot_fuel_subs = sum(B7_subs)) %>%
  ungroup() %>%
  group_by(flag, fao_region) %>%
  summarize(fmi_weighted_avg = weighted.mean(fmi_best, catch),
            tot_bad_subs = unique(tot_bad_subs),
            tot_fuel_subs = unique(tot_fuel_subs))

ggplot(fmi_flag_fao)+
  aes(x = tot_bad_subs, y = fmi_weighted_avg)+
  geom_point()+
  theme_linedraw()+
  labs(x = "Total capacity-enhancing subsidies (2018 $US)",
       y = "Mean Weighted FMI")+
  scale_y_continuous(limits = c(0,1))+
  scale_x_continuous(labels = comma)

# FMI by flag from vessel list
fmi_flag <- vessel_list_manage %>%
  group_by(flag) %>%
  mutate(tot_bad_subs = sum(bad_subs),
         tot_fuel_subs = sum(B7_subs)) %>%
  ungroup() %>%
  group_by(flag) %>%
  summarize(fmi_weighted_avg = weighted.mean(fmi_best, catch),
            tot_bad_subs = unique(tot_bad_subs),
            tot_fuel_subs = unique(tot_fuel_subs))

ggplot(fmi_flag)+
  aes(x = tot_bad_subs, y = fmi_weighted_avg)+
  geom_point()+
  theme_linedraw()+
  labs(x = "Total capacity-enhancing subsidies (2018 $US)",
       y = "Mean Weighted FMI")+
  scale_y_continuous(limits = c(0,1))+
  scale_x_continuous(labels = comma)

countries_to_highlight <- c("CHN", "USA", "IDN", "JPN", "ISL", "THA")
  
# FMI by just from Melnychuk et al
fmi_flag_melnychuk_only <- vessel_list_manage %>%
  group_by(flag) %>%
  summarize(tot_bad_subs = sum(bad_subs),
         tot_fuel_subs = sum(B7_subs),
         tot_landings = sum(catch)) %>%
  right_join(melnychuk_2017_mgmt_dat, by = c("flag" = "iso3")) %>%
  mutate(display_name = case_when(flag %in% countries_to_highlight ~ countrycode(flag, "iso3c", "country.name")))

# plot
ggplot(fmi_flag_melnychuk_only)+
  aes(x = tot_bad_subs/1e6, y = fmi_weighted, size = tot_landings/1e6, color = display_name)+
  geom_point()+
  geom_text_repel(aes(label = display_name), size = 4, force = 100, point.padding = 0.25, box.padding = 1)+
  theme_linedraw()+
  labs(x = "Total capacity-enhancing subsidies (million 2018 $US)",
       y = "Weighted FMI")+
  scale_y_continuous(limits = c(0,1))+
  scale_x_continuous(labels = comma)+
  scale_size(range = c(2,8), breaks = c(5,10,15), limits = c(0,15), name = "Marine Capture Production (million mt, 2017)")+
  theme(legend.position = "top")+
  scale_color_discrete(guide = "none")

ggsave(paste0(results_dir, "fmi_flag_melnychuk_allbad.png"), width = 7, height = 4.5, units = "in")

# Plot fuel subsidies only 
ggplot(fmi_flag_melnychuk_only)+
  aes(x = tot_fuel_subs/1e6, y = fmi_weighted, size = tot_landings/1e6, color = display_name)+
  geom_point()+
  geom_text_repel(aes(label = display_name), size = 4, force = 100, point.padding = 0.25, box.padding = 1)+
  theme_linedraw()+
  labs(x = "Total fuel subsidies (million 2018 $US)",
       y = "Weighted FMI")+
  scale_y_continuous(limits = c(0,1))+
  scale_x_continuous(labels = comma)+
  scale_size(range = c(2,8), breaks = c(5,10,15), limits = c(0,15), name = "Marine Capture Production (million mt, 2017)")+
  theme(legend.position = "top")+
  scale_color_discrete(guide = "none")

ggsave(paste0(results_dir, "fmi_flag_melnychuk_fuel.png"), width = 7, height = 4.5, units = "in")

}
```

```{r}
# For later use, get fraction of catch in each region from catch share fisheries, vs. not
# costello_catch_share_frac <- costello_2016_dat_edit %>%
#   group_by(region, catch_share) %>%
#   summarize(landings = sum(catch_new, na.rm = T)) %>%
#   ungroup() %>%
#   group_by(region) %>%
#   mutate(tot_landings = sum(landings, na.rm = T)) %>%
#   ungroup() %>%
#   mutate(frac_landings = landings/tot_landings) %>%
#   arrange(region)
```