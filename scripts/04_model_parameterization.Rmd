---
output:
  html_document: default

title: "SubsidyExplorer - Step 3: Model Parameterization"
author: "Kat Millage, Vienna Saccomanno, Laura Lea Rubino, Christopher Costello"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 11pt
bibliography: "../pew-subsidies.bib"

---

# Introduction 

This script handles the preliminary data wrangling necessary to create the biological parameters for the bio-economic model underlying the SubsidyExplorer toolkit. It outputs two CSV files used by the SubsidyExplorer toolkit (located in `r here::here("WTOToolkit", "data")`): 
- model-parameters-global.csv
- model-parameters-regional.csv

```{r}
# Load packages
library(knitr) 
library(countrycode) # country name matching
library(janitor) # cleaning column names
library(readxl) # Load XLSX files
library(tidyverse)

# Path to Costello upsides data
costello_2016_upsides_dat_path <- here::here("data", "edited", "costello_et_al_2016_upsides_tidy.csv")

# Path to vessel list
vessel_list_path <- here::here("results", "03-management", "vessel_list_2018_management.csv")
```

In addition to the data sources described in the inital data wrangling script, we also draw on the folloing data sources: 

- Bioeconomic model parameters from both of the World Bank's Sunken Billions Reports (2009 and 2017). 
> World Bank, & FAO. (2009). The Sunken Billions: The Economic Justification for Fisheries Reform. Retrieved from https://siteresources.worldbank.org/EXTARD/Resources/336681-1224775570533/SunkenBillionsFinal.pdf
> World Bank. (2017). The Sunken Billions Revisited: Progress and Challenges in Global Marine Fisheries. Retrieved from https://openknowledge.worldbank.org/handle/10986/24056


```{r setup, include=FALSE}
# Code options
knitr::opts_chunk$set(echo = FALSE, error = FALSE, message = FALSE, warning = F)

# Directories for the output files generated by this script
results_dir <- here::here("results", "3-model-parameterization/")
if (dir.exists(results_dir) == F) {
  dir.create(results_dir, recursive = T)
}

app_dir <- here::here("app", "data/")
if (dir.exists(app_dir) == F) {
  dir.create(app_dir, recursive = T)
}

# Define regions 
region_names <- sort(c("atlantic", "indian", "pacific_e", "pacific_w"))

# Create a tidy df with the cooresponding fao regions
regions_tidy <- tibble(
  region = region_names,
  fao_region = list(c(21, 27, 37, 31, 34, 41, 47, 18, 48), c(51, 57, 58), c(67, 77, 87), c(61, 71, 81, 88))
) %>%
  unnest(cols = c(fao_region))

# Also create a blank tibble with regions as column names
regions_spread <- setNames(data.frame(matrix(ncol = length(region_names), nrow = 0)), region_names)

# Now make empty output tables for both our global parameters, and for our regional parameters
global_model_parameters <- tibble(parameter = character(0), value = numeric(0), source = character(0))

regional_model_parameters <- tibble(parameter = character(0), source = character(0)) %>%
  bind_cols(regions_spread)
```

```{r}
# Load data sets
# Load costello data
costello_2016_dat <- read_csv(costello_2016_path) %>%
  clean_names(case = "snake")

# Load vessel list
vessel_list_mgmt <- read.csv(vessel_list_path, stringsAsFactors = F)

# Create cutoffs determining which vessels are in which fleets
managed_cutoff <- quantile(vessel_list_mgmt$fmi_best, probs = seq(0,1,0.33))[3]

# Assign management criteria
vessel_list_out <- vessel_list_mgmt %>%
  mutate(fleet = case_when(fmi_best >= managed_cutoff ~ "managed",
                           TRUE ~ "open_access")) %>%
  left_join(regions_tidy, by = c("fao_region" = "fao_region"))

```


# Step 1: Biomass growth function

For our biomass growth function, $G(b)$, we use a form of the basic logistic surplus production model commonly referred to as the Pella-Tomlinson Model. With discrete units of time (hereafter years for the purposes of our model), biomass in the next year, $b_{t+1}$, is given by: 

$$ b_{t+1} = b_{t} + \frac{\phi + 1}{\phi} r b_{t}\Bigg(1 - \bigg(\frac{b_{t}}{K}\bigg)^{\phi}\Bigg) - h_{t}$$
where $\phi$ is the Pella-Tomlinson parameter that allows for asymmetry in the production curve (centered on $phi = 1$), $r$ characterizes the intrinsic growth rate of the global stock, $K$ is the carrying capacity (maximum population size for growth to be positive), and $h_t$ is the total harvest in that year across all fleets. 

Certain attributes of the Pella-Tomlinson biomass growth function relate its paramters to stock characteristics. For instance, $r$ can be calculated as

$$ r = \bigg(\frac{MSY}{K} \bigg) (\phi + 1)^{\frac{1}{\phi}} $$

where $MSY$ is the maximum sustinable yield of the stock, and $K$ is the carrying capacity of the stock. 

We therefore need to estimate the following parameters for the biomass growth function: 
- $\phi$ : Pella-Tomlinson shape parameter (no units)
- $MSY$ : Global maximum sustainable yield (tons)
- $K$ : Global biomass carrying capacity (tons)
- $r$ : Global biomass intrinsic growth rate (no units)

The following parameters will be estimated prior to each model run:
- $b_0$ : Global biomass in the base year (tons)

<!-- ## Alternative form of the Pella-Tomlinson biomass growth function -->

<!-- The biomass growth function can also be written as: -->

<!-- $$ G(b) = \alpha b - \beta b^\phi $$ -->
<!-- where $\phi$ is the Pella-Tomlinson exponent dictating how skewed the growth curve is (centered on $\phi = 2$), $\alpha$ is the intrinsic growth rate, and $\beta$ is another parameter.  -->

<!-- In this case, $\alpha$ can be estimated as: -->

<!-- $$ \alpha = \bigg(\frac{MSY}{K}\bigg) \bigg(\frac{\phi^\frac{\phi}{\phi - 1}}{\phi - 1}\bigg) $$ -->

<!-- where $MSY$ is the maximum sustinable yield of the stock, and $K$ is the carrying capacity of the stock.  -->

<!-- Similarly, $\beta$ can be estimated as:  -->

<!-- $$ \beta = \bigg(\frac{MSY}{K^\phi}\bigg) \bigg(\frac{\phi^\frac{\phi}{\phi - 1}}{\phi - 1}\bigg) $$ -->

## Global biological parameters

We first parameterize our bio-economic model of fisheries subsidies reform globally. 

We assume $\phi = 1.188$ based on literature for all (Thorson et al. 2012; World Bank 2017). 

```{r}
# Phi
phi <- 0.188

# Add phi to parameter table
global_model_parameters <- global_model_parameters %>%
  bind_rows(tibble(parameter = "phi", value = phi, source = "Thorson et al. 2012"))
```

We then need to calculate $r$, for which we need both $MSY$ and $K$. 

Many different estimates of the global marine $MSY$ exist, generally ranging between 80 and 115 million tons. Different sources have used different estimates: 
- The initial Sunken Billions report (World Bank and FAO 2009): 95 million tons
- Sumaila et al. 2012: 83 - 99 million tons
- Costello et al. 2012: 85 - 110 million tons
- The second Sunken Billions report (World Bank 2017): 102 million tons

For this analyis, we use the database of stock statuses for more than 4,000 fisheries (representing ~78% of global fisheries) created by Costello et al. (2016). MSY for our model is defined as the sum of the MSY of all stocks contained in this dataset, adjusted for the fraction of global biomass estimated to be represented by this data. 

```{r}
# Calculate global MSY
global_msy <- sum(costello_2016_dat$msy)/0.78

# Add MSY to parameter table
global_model_parameters <- global_model_parameters %>%
  bind_rows(tibble(parameter = "MSY", value = global_msy, source = "Costello et al. 2016"))

```

We therefore assume that the global MSY is therefore equal to `r format(global_msy, big.mark = ",")` tons, which is comparable to the estimates used by other studies. 

Very little is known about the global carrying capacity of fish stocks, though many studies have suggested that it is between 5 and 15 times the MSY for different species of fish. Again using the database of stock statuses created by Costello et al. (2016), we can obtain an estimate of global carrying capacity by summing the carrying capacities of all stocks contained in this dataset, adjusted for the fraction of global biomass estimated to be represented by this data. 

```{r}
# One estimate of global carrying capacity
global_k <- sum(costello_2016_dat$k)/0.78
```

That yields a global carrying capacity equal to `r format(global_k, big.mark = ",")` tons, which is `r global_k/global_msy` times our estimate of global MSY. We not that this is  significantly higher than estimates of global carrying capacity used by other studies.  

```{r}
# Add K to parameter table
global_model_parameters <- global_model_parameters %>%
  bind_rows(tibble(parameter = "K", value = global_k, source = "Costello et al. 2016"))
```

<!-- That yields a global carrying capacity equal to `r format(global_k, big.mark = ",")` tons, which is much closer to the estimate of 980 million tons used by the World Bank (2017) study.  -->

We can then use all three parameters to estimate the global intrinsic growth rate. 

```{r}
# Calculate r
global_r <- (global_msy/global_k)*(phi+1)^(1/phi) 

# Add r to parameter table
global_model_parameters <- global_model_parameters %>%
  bind_rows(tibble(parameter = "r", value = global_r, source = "Costello et al. 2016"))
```


```{r}
# # NEED TO FIX THIS
global_biomass <- global_k*0.306

# Add base year biomass to parameter table
# global_model_parameters <- global_model_parameters %>%
#   bind_rows(tibble(parameter = "B0", value = global_biomass, source = "Costello et al. 2016"))
```


## Regional biological parameters

We also apply our bio-economic model of fisheries subsidies reform on a regional basis. For this analysis, we have chosen to use five regions based loosly on the major ocean basins and using the FAO statistical regions as subdivisions as needed to further separate regions: Arctic (18), Atlantic and Mediterranean (21, 27, 31, 34, 37, 41, 47), Indian (51, 57), Eastern Pacific (67, 77, 87), Western Pacific (61, 71, 81), and Southern (48, 58, 88). 

This regional breakdown was chosen with the goal of trying to reflect commonly used delimitations of the boundaries of the world's largest fish stocks. Regional characterizations used by other studies (see World Bank 2017) are often organized around continents and political boundaries, which is inherently problematic for fisheries as most of the world's major fish stocks straddle these boundaries. While our regional model has tried to overcome some of these problems by aggregating ocean areas with more similar physical characteristics, we aknowledge that our results by region are likely to be less dependable than our global results. 

For the regional portion of our analysis, we needed to calculate all of the same model inputs used in the global model for each of our six regions. 

First, we assume that $\phi$ remains constant across regions ($\phi = 1.188$, Thorson et al. 2012).

```{r}
# Apply phi regionally
regional_phi <- rep(phi, length = length(region_names))
names(regional_phi) <- region_names

# Add phi to the regional paramter table
regional_model_parameters <- regional_model_parameters %>%
  bind_rows(c("parameter" = "phi", "source" = "Thorson et al. 2012", regional_phi))
```

Then, regional values of MSY were estimated in the same way as for the global fishery. We summed the MSYs of all stocks in the FAO statistical areas comprising each region from Costello et al. 2016. In cases where stocks in this dataset were associated with multiple FAO statistical areas, we assume that the stock's MSY and carrying capacity is split evenly between areas. 

```{r}
# Create new row for every FAO statistical region - For stocks spanning multiple fao statistical regions, we assume msy/carrying capacity is split equally between them. 
# In most cases this doesn't matter since we've defined our regions in a way where the entire stock is in the same region, even if it spans multiple fao statistical areas 
costello_2016_dat_edit <- costello_2016_dat %>%
  mutate(region_fao_chr = as.character(region_fao),
         n_regions = nchar(region_fao_chr)/2,
         region_fao_split = str_split(gsub("(.{2})", "\\1 ", region_fao_chr), " ")) %>%
  unnest(cols = c(region_fao_split)) %>%
  mutate(region_fao_split = as.numeric(region_fao_split)) %>%
  dplyr::filter(region_fao_split != "") %>%
  mutate(msy_new = msy/n_regions,
         k_new = k/n_regions,
         biomass_new = biomass/n_regions,
         catch_new = catch/n_regions) %>%
  left_join(regions_tidy, by = c("region_fao_split" = "fao_region"))

# Now aggregate by region
costello_regional_dat <- costello_2016_dat_edit %>%
  group_by(region) %>%
  summarize(msy = sum(msy_new, na.rm = T)/0.78,
            k = sum(k_new, na.rm = T)/0.78,
            price = median(price, na.rm = T),
            bv_bmsy = median(bv_bmsy, na.rm = T),
            biomass = sum(biomass_new, na.rm = T),
            catch = sum(catch_new, na.rm = T)) %>%
  arrange(region)

# Extract msy
regional_msy <- round(costello_regional_dat$msy)
names(regional_msy) <- region_names

# Add MSY to the regional paramter table
regional_model_parameters <- regional_model_parameters %>%
  bind_rows(c("parameter" = "MSY", "source" = "Costello et al. 2016", regional_msy))
```

We do the same for regional carrying capacities. 

```{r}
# Extract carrying capacity
regional_k <- round(costello_regional_dat$k)
names(regional_k) <- region_names

# Add MSY to the regional paramter table
regional_model_parameters <- regional_model_parameters %>%
  bind_rows(c("parameter" = "K", "source" = "Costello et al. 2016", regional_k))
```

We then calculate regional growth rates using those values of MSY and K. 

```{r}
# Calculate r regionally
regional_r <- (regional_msy/regional_k)*(regional_phi+1)^(1/regional_phi) 

# Add r to parameter table
regional_model_parameters <- regional_model_parameters %>%
  bind_rows(c("parameter" = "r", "source" = "Costello et al. 2016", regional_r))
```

```{r}
# # NEED TO FIX THIS
regional_biomass <- regional_k * 0.306

# Add biomass to parameter table
# regional_model_parameters <- regional_model_parameters %>%
#   bind_rows(c("parameter" = "B0", "source" = "Costello et al. 2016", regional_biomass))
```


<!-- xxxxxxxxxxxxxxxxxxxx -->

# Step 2: Harvest function

Our harvest function, $Y(b,e)$, is really the sum of the individual harvest functions for our three fleet segments (managed, intermediate, and open-access). Harvest for each fleet in a given year, $h_{j,t}$, is represented by: 

$$ h_{j,t} = q_{j} b_{t} e_{j,t} $$

where $q_j$ is a fleet specific catchability parameter, and $e_{j,t}$ is the fishing effort expended by that fleet that year. We estimate catchability directly for each fleet based on base year data by calculating $q_j$ as follows:

$$ q_{j} = \frac{h_{j,0}}{b_{0}*e_{j,0}} $$

The total harvest is therefore the sum of harvests across all fleets: 

$$ h_{t} = \sum_{i=1}^{j} h_{j,t} $$

The following parameters are calculuated prior to every model run as they vary depending on the relative sizes of the fleet:
- $h_{j,0}$ : Base year harvest for each fleet (tons)
- $e_{j,0}$ : Base year effort for each fleet (kWh)
- $q_{j}$ : Catchability for each fleet (tons)

<!-- ## Global harvest parameters -->

<!-- We calculate base year harvest for each fleet based on total marine capture production (2017) from the FAO.  -->

```{r}
# Group by fleet and calculate base year harvest and effort for the global fleet
global_fleet <- vessel_list_out %>%
  group_by(fleet) %>%
  summarize(vessels = n_distinct(ssvid),
            fishing_KWh = sum(fishing_KWh_eez_fao, na.rm = T),
            catch = sum(catch, na.rm = T),
            revenue = sum(revenue, na.rm = T),
            bad_subs = sum(bad_subs, na.rm = T))

# Add base year harvest to parameter table
# global_model_parameters <- global_model_parameters %>%
#   bind_rows(tibble(parameter = "h0_managed", value = global_fleet$catch[global_fleet$fleet == "managed"], source = "FAO 2019"))
# global_model_parameters <- global_model_parameters %>%
#   bind_rows(tibble(parameter = "h0_oa", value = global_fleet$catch[global_fleet$fleet == "open_access"], source = "FAO 2019"))

```

Base gear effort for each fleet comes from GFW data (2018). Effort is given in units of kW hours, which is a combination of the hours spent engaged in fishing activity, and the engine capacity of the vessel in KW.

```{r}
# global_model_parameters <- global_model_parameters %>%
#   bind_rows(tibble(parameter = "e0_managed", value = global_fleet$fishing_KWh[global_fleet$fleet == "managed"], source = "GFW 2019"))
# global_model_parameters <- global_model_parameters %>%
#   bind_rows(tibble(parameter = "e0_oa", value = global_fleet$fishing_KWh[global_fleet$fleet == "open_access"], source = "GFW 2019"))
```

We then estimate catchability for both fleets using the equation listed above

```{r}
catchability_global <- global_fleet$catch/(global_biomass*global_fleet$fishing_KWh)

# global_model_parameters <- global_model_parameters %>%
#   bind_rows(tibble(parameter = "q_managed", value = catchability_global[1], source = "FAO 2019; GFW 2019"))
# global_model_parameters <- global_model_parameters %>%
#   bind_rows(tibble(parameter = "q_oa", value = catchability_global[2], source = "FAO 2019; GFW 2019"))
```

## Regional harvest paramters

We do the same process to calculate base year harvest and effort, but aggregate by fleet and region.

```{r}
# Assign regions
# vessel_list_out <- vessel_list_out %>%
#   left_join(regions_tidy, by = c("fao_region" = "fao_regions"))

# Group by fleet and calculate base year harvest and effort for the global fleet
regional_fleet <- vessel_list_out %>%
  group_by(region, fleet) %>%
  summarize(vessels = n_distinct(ssvid),
            fishing_KWh = sum(fishing_KWh_eez_fao, na.rm = T),
            catch = sum(catch, na.rm = T),
            revenue = sum(revenue, na.rm = T),
            bad_subs = sum(bad_subs, na.rm = T)) %>%
  arrange(region, fleet)

# Get harvest
regional_fleet_harvest <- regional_fleet %>%
  dplyr::select(region, fleet, catch) %>%
  spread(region, catch)

# Get effort
regional_fleet_effort <- regional_fleet %>%
  dplyr::select(region, fleet, fishing_KWh) %>%
  spread(region, fishing_KWh)

# Add base year harvest to parameter table
# regional_model_parameters <- regional_model_parameters %>%
#   bind_rows(c("parameter" = "h0_managed", "source" = "FAO 2019", unlist(regional_fleet_harvest[1,-1])))
# regional_model_parameters <- regional_model_parameters %>%
#   bind_rows(c("parameter" = "h0_oa", "source" = "FAO 2019", unlist(regional_fleet_harvest[2,-1])))
# 
# # Add base year effort to parameter table
# regional_model_parameters <- regional_model_parameters %>%
#   bind_rows(c("parameter" = "e0_managed", "source" = "GFW 2019", unlist(regional_fleet_effort[1,-1])))
# regional_model_parameters <- regional_model_parameters %>%
#   bind_rows(c("parameter" = "e0_oa", "source" = "GFW 2019", unlist(regional_fleet_effort[2,-1])))
```

Now we calculate catchability for each fleet regionally

```{r}
# Calculate catchability regionally
catchability_regional <- tibble(fleet = c("managed", "open_access"))

for(i in 2:ncol(regional_fleet_harvest)){

  out <- tibble(unlist(regional_fleet_harvest[,i])/(regional_biomass[i-1]*unlist(regional_fleet_effort[,i])))
  colnames(out) <- region_names[i-1]

  catchability_regional <- catchability_regional %>%
    bind_cols(out)

}
# Add catchability to parameter table
# regional_model_parameters <- regional_model_parameters %>%
#   bind_rows(c("parameter" = "q_managed", "source" = "FAO 2019; GFW 2019", unlist(catchability_regional[1,-1])))
# regional_model_parameters <- regional_model_parameters %>%
#   bind_rows(c("parameter" = "q_oa", "source" = "FAO 2019; GFW 2019", unlist(catchability_regional[2,-1])))

```

<!-- xxxxxxxxxxxxxxxxxxxx -->

# Step 3: Global fish demand

In order to allow the price of fish to change as a function of harvest, we introduce a demand function, $D(h)$, for fish, and we assume it is downward-sloping. Total harvest in a given year, $h_{t}$, gives rise to fish price, $p_t$, through the constant elasticity of demand function: 

$$ p_{t} = \bigg(\frac{1}{\delta}\bigg)^{1/\epsilon} h_{t}^{1/\epsilon} $$

where $\epsilon$ is the constant elasticity of demand, and $\delta$ is a constant. We calculate the parameter $\delta$ using data from Costello et al. (2016) as follows: 

$$ \delta = \frac{h_{2012}}{(p_{2012})^{\epsilon}}$$

We therefore need to estimate the following parameters for the demand function: 
- $\epsilon$ : price flexibility/constant elasticity of demand

The following parameters are calculated prior to each time step: 
- $\delta$ : price constant

## Global demand parameters

We assume that the price flexibility/elasticity ($\epsilon$) is equal to -1.15 based on Costello et al. (2016). 

```{r}
# Global price flexibility
global_epsilon <- -1.15

# Add base year biomass to parameter table
global_model_parameters <- global_model_parameters %>%
  bind_rows(tibble(parameter = "epsilon", value = global_epsilon, source = "Costello et al. 2016"))
```

<!-- We can then calculate the price constant using 2012 data from Costello et al. (2016).  -->

```{r}
# Global price constant
global_price_wrangling <- costello_2016_dat %>%
  group_by(year) %>%
  summarize(price = median(price, na.rm = T),
            harvest = sum(catch, na.rm = T))

global_delta <- global_price_wrangling$harvest/(global_price_wrangling$price^global_epsilon)

# Add price constant to parameter table
# global_model_parameters <- global_model_parameters %>%
#   bind_rows(tibble(parameter = "delta", value = global_delta, source = "Costello et al. 2016"))
```

## Regional demand parameters

For the regional analysis, we assume that the price flexibility/elasticity ($\epsilon$) is equal to -1.15 for all regions based on Costello et al. (2016). 

```{r}
# Regional price flexibility
regional_epsilon <- rep(-1.15, length = length(region_names))
names(regional_epsilon) <- region_names

# Add epsilon to parameter table
regional_model_parameters <- regional_model_parameters %>%
  bind_rows(c("parameter" = "epsilon", "source" = "Costello et al. 2016", regional_epsilon))
```

<!-- We then calculate the price constant for each region using 2012 data from Costello et al. (2016).  -->

```{r}
# Regional price constant
regional_delta <- costello_regional_dat$catch/(costello_regional_dat$price^regional_epsilon)

# Add price constant to parameter table
# regional_model_parameters <- regional_model_parameters %>%
#   bind_rows(c("parameter" = "delta", "source" = "Costello et al. 2016", regional_delta))
```

<!-- xxxxxxxxxxxxxxxxxxxx -->

# Step 4: Costs and Benefits

Our cost function, $C(e)$, assumes that each fleet's total costs ($c_{j,t}$) are a function of fishing effort in that time step ($e_{j,t}$) and a fleet-specific cost coefficient ($\alpha_{j}$):
$$ c_{j,t} = \alpha_{j}  e_{j,t}^{\beta}$$

where $\beta$ is a scalar cost parameter that determines the shape of the cost curve (i.e. how non-linear costs are). The cost coefficient $\alpha_{j}$ for each fleet is a function of how much each unit of effort is being subsidized for that fleet $s_{j,t}$. We estimate the costs for each fleet directly based on base year data by calculating $\alpha_{j}$ as follows: 
$$ \alpha_{j} = \frac{p_{0}h_{j,0} + s_{j,0} e_{j,0}}{(e_{j,0})^{\beta}}$$

Fisheries profits are then calculated as revenue less costs plus subsidies for each fleet, where revenue is the fish price $p_t$ times harvest $h_{j,t}$ and costs are calculated as above. Profits for each fleet in each year, $\pi_{j,t}$, are therefore equal to:

$$ \pi_{j,t} = p_{t} h_{j,t} - c_{j,t} + s_{j,t}e_{j,t} $$

where $s_{j,t}$ is the rate of subsidization (i.e. how much each unit of effort is being subsidized) for fleet $j$. 

Effort in the next year, $e_{j,t+1}$, adjusts in response to profits differently for each of our two fleets: 

1) For the managed fleet, we assume that effort is decoupled from costs, and therefore remains constant regardless of changes to profits: 

$$ e_{M,t+1} = e_{M,t}$$

2) For the open-access fleet, we assume that effort is coupled to costs, and therefore adjusts in response to profits:

$$ e_{OA,t+1} = \eta \pi_{OA,t} + e_{OA,t}$$
where $\eta$ is a parameter that regulates the speed at which effort is able to enter and exit the fishery.

We therefore need to estimate the following parameters for the cost and profit functions:
- $\beta$ : scalar cost parameter
- $p_{0}$ : base year fish price ($/ton)
- $\eta$ : speed at which effort is able to enter/exis a fishery

The following parameters are estimated prior to the start of each model run as they depend on the relative sizes of the fleets:
- $s_{j,0}$ : base year rate of subsidization for each fleet ($/kWh)
- $\alpha_{j}$ : cost coefficient for each fleet

## Global cost parameters

For our global analysis, we assume that $\beta$ is equal to 1.3 (Costello et al. 2016). 

```{r}
# Define global beta
global_beta <- 1.3

# Add to parameter table
global_model_parameters <- global_model_parameters %>%
  bind_rows(tibble(parameter = "beta", value = global_beta, source = "Costello et al. 2016"))
```

In order to calculate $\alpha$, we first need to determine fish price in the base year. We compare two alternatives - 1) using the median price from Costello et al. (2016) adjusted to 2018 US$, and 2) solving for price based on the observed base year harvest. 

```{r}
# Calculate global base prices
global_base_price1 <- ((1/global_delta)^(1/global_epsilon))*(sum(global_fleet$catch)^(1/global_epsilon))

CPI_2012 <- 229.594  #BLS CPI All Items (Annual Ave), (BLS Series ID: CUUR0000SA0)
CPI_2018 <- 251.107  #BLS CPI All Items (Annual Ave), (BLS Series ID: CUUR0000SA0)

global_base_price2 <- global_price_wrangling$price * (CPI_2018/CPI_2012)
```

The second price looks a bit high (comparable global price estimates are in the range of $1200-1400 per ton), so we use the first. 

```{r}
# Add to parameter table
global_model_parameters <- global_model_parameters %>%
  bind_rows(tibble(parameter = "p0", value = global_base_price1, source = "Costello et al. 2016"))
```

We then can calculate the rate of subsidization in the base year using the subsidy estimates from Sumaila et al. 

```{r}
# Calculate global base subsidies
global_base_subsidies <- global_fleet$bad_subs/global_fleet$fishing_KWh

# Add to parameter table
# global_model_parameters <- global_model_parameters %>%
#   bind_rows(tibble(parameter = "s0_managed", value = global_base_subsidies[1], source = "Sumaila et al. 2019"))
# global_model_parameters <- global_model_parameters %>%
#   bind_rows(tibble(parameter = "s0_oa", value = global_base_subsidies[2], source = "Sumaila et al. 2019"))
```

And now we are able to estimate the cost coefficients for each fleet. 

```{r}
# Calculate cost coefficients 
global_cost_coeff <- ((global_base_price1*global_fleet$catch) + (global_base_subsidies*global_fleet$fishing_KWh))/(global_fleet$fishing_KWh^global_beta)

# Add to parameter table
# global_model_parameters <- global_model_parameters %>%
#   bind_rows(tibble(parameter = "alpha_managed", value = global_cost_coeff[1], source = "Calculated"))
# global_model_parameters <- global_model_parameters %>%
#   bind_rows(tibble(parameter = "alpha_oa", value = global_cost_coeff[2], source = "Calculated"))
```

Finally, we assume that $\eta$ is equal to 0.1 based on literature (Costello et al. 2016). 

```{r}
# Define global eta
global_eta <- 0.1

# Add to parameter table
global_model_parameters <- global_model_parameters %>%
  bind_rows(tibble(parameter = "eta", value = global_eta, source = "Calculated"))
```

## Regional cost parameters

As with the global analysis, we assume $\beta$ to be equal to 1.3 across all regions. 

```{r}
# Define global beta
regional_beta <- rep(1.3, length = length(region_names))
names(regional_beta) <- region_names

# Add to parameter table
regional_model_parameters <- regional_model_parameters %>%
  bind_rows(c("parameter" = "beta", "source" = "Costello et al. 2016", regional_beta))
```

We then calculate price in the base year in the same way regionally

```{r}
# Calculate base price regionally
regional_catches_total <- regional_fleet_harvest %>%
  gather(region, catch, -1) %>%
  group_by(region) %>%
  summarize(catch = sum(catch)) %>%
  spread(region, catch)

regional_base_price1 <- ((1/regional_delta)^(1/regional_epsilon))*(unlist(regional_catches_total[1,])^(1/regional_epsilon))

# Add catchability to parameter table
regional_model_parameters <- regional_model_parameters %>%
  bind_rows(c("parameter" = "p0", "source" = "Calculated", regional_base_price1))

```

As well as the rate of subsidization by fleet and region in the base year

```{r}
# get subsidy rates regionally by fleet
# Get effort
regional_fleet_subs <- regional_fleet %>%
  dplyr::select(region, fleet, bad_subs) %>%
  spread(region, bad_subs)

subsidies_regional <- tibble(fleet = c("managed", "open_access"))

for(i in 2:ncol(regional_fleet_subs)){
  
  out <- tibble(unlist(regional_fleet_subs[,i])/unlist(regional_fleet_effort[,i]))
  colnames(out) <- region_names[i-1]
  
  subsidies_regional <- subsidies_regional %>%
    bind_cols(out)
  
}

# Add subsidy base to parameter table
# regional_model_parameters <- regional_model_parameters %>%
#   bind_rows(c("parameter" = "s0_managed", "source" = "Sumaila et al. 2019; GFW 2019", unlist(subsidies_regional[1,-1])))
# regional_model_parameters <- regional_model_parameters %>%
#   bind_rows(c("parameter" = "s0_oa", "source" = "Sumaila et al. 2019; GFW 2019", unlist(subsidies_regional[2,-1])))
```

So we estimate cost coefficients for each fleet

```{r}

cost_coeff_regional <- tibble(fleet = c("managed", "open_access"))

for(i in 2:ncol(regional_fleet_subs)){
  
  out <- tibble(
    ((regional_base_price1[i-1]*unlist(regional_fleet_harvest[,i])) + 
      (unlist(subsidies_regional[,i])*unlist(regional_fleet_effort[,i]))) /
      (unlist(regional_fleet_effort[,i])^regional_beta[i-1])
    )
  colnames(out) <- region_names[i-1]
  
  cost_coeff_regional <- cost_coeff_regional %>%
    bind_cols(out)
  
}

# Add subsidy base to parameter table
# regional_model_parameters <- regional_model_parameters %>%
#   bind_rows(c("parameter" = "alpha_managed", "source" = "Calculated", unlist(cost_coeff_regional[1,-1])))
# regional_model_parameters <- regional_model_parameters %>%
#   bind_rows(c("parameter" = "alpha_oa", "source" = "Calculated", unlist(cost_coeff_regional[2,-1])))

```

And we again assume $\eta$ to be equal to 0.1 across all regions

```{r}
regional_eta <- rep(0.1, length = length(region_names))
names(regional_eta) <- region_names

# Add subsidy base to parameter table
regional_model_parameters <- regional_model_parameters %>%
  bind_rows(c("parameter" = "eta", "source" = "Costello et al. 2016", regional_eta))
```


```{r}
# Save both parameter files
write_csv(global_model_parameters, paste0(results_dir, "global-model-parameters.csv"))
write_csv(global_model_parameters, paste0(app_dir, "global-model-parameters.csv"))

write_csv(regional_model_parameters, paste0(results_dir, "regional-model-parameters.csv"))
write_csv(regional_model_parameters, paste0(app_dir, "regional-model-parameters.csv"))

# Save vessel list
write_csv(vessel_list_out, paste0(results_dir, "vessel-list-2018-regions.csv"))
```

<!-- xxxxxxxxxxxxxxxxxxxx -->


