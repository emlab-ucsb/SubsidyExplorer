---
output:
  html_document: default

title: "SubsidyExplorer - Step 4: Apply proposal 'definitions' to vessel list"
author: "Kat Millage, Vienna Saccomanno, Laura Lea Rubino, Christopher Costello"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 11pt
bibliography: "../pew-subsidies.bib"

---

# Introduction

The purpose of this script is to apply "definitions" to our global vessel list in order to make it easier to identify which vessels would be likely to be affected by each of the subsidy reform policies under consideration by the WTO. Storing whether each vessel meets a certain "definition" (i.e. qualification) speeds up selection of affected vessels within the SubsidyExplorer toolkit. 

```{r}
# Load packages
library(knitr) 
library(countrycode) # country name matching
library(janitor) # cleaning column names
library(tidyverse)

# Package to normalize vessel names in the same way GFW normalizes vessel names
#devtools::install_github("jcvdav/startR")
library(startR)

# Path to global vessel list
vessel_list_path <- here::here("results", "3-model-parameterization", "vessel-list-2018-regions.csv")

# Paths to other data files
iuu_dat_path <- here::here("data", "raw", "fisheries", "IUU_Vessel_List", "IUUList-20190430.csv")
costello_2016_path <- here::here("data", "raw", "fisheries", "Costello_2016", "ProjectionData_2012.csv")

```

```{r}
# Code options
knitr::opts_chunk$set(echo = FALSE, error = FALSE, message = FALSE, warning = F)

# Directories for the output files generated by this script
results_dir <- here::here("results", "5-vessel-list-policy-definitions/")
if (dir.exists(results_dir) == F) {
  dir.create(results_dir, recursive = T)
}

app_dir <- here::here("WTOtoolkit", "data/")
if (dir.exists(app_dir) == F) {
  dir.create(app_dir, recursive = T)
}

```

# Input vessel info table

Our global vessel info table was created in a previous script (`r here::here("scripts", "1-vessel-list.Rmd")`) and saved to `r vessel_list_path`. 

```{r}
vessel_list <- read.csv(vessel_list_path, stringsAsFactors = F)
```

```{r}
# EU countries
#Belgium, Bulgaria, Croatia, Cyprus, Denmark, Estonia, Finland, France, Germany, Greece, Ireland, Italy, Latvia, Lithuania, Malta, Netherlands, Poland, Portugal, Romania, Slovenia, Spain, Sweden, United Kingdom
eu_countries <- c("BEL", "BGR", "HRV", "CYP", "DNK", "EST", "FIN", "FRA", "DEU", "GRC", "IRL", "ITA", "LVA", "LTU", "MLT", "NLD", "POL", "PRT", "ROU", "SVN", "ESP", "SWE", "GBR")

# Dutch overseas territories: Aruba, Bonaire/St. Eustatius/Saba, Curacao, Sint Maarten
dutch_territories <- c("ABW", "BES", "CUW", "SXM")

# French overseas territories: French Guiana, French Polynesia, French Southern and Antarctic Territories, Guadeloupe, Martinique, Mayotte, New Caledonia, Reunion, Saint Barthelemy, Saint Martin, St. Pierre and Miquelon, Wallis and Futuna Islands
french_territories <- c("GUF", "PYF", "ATF", "GLP", "MTQ", "MYT", "NCL", "REU", "BLM", "MAF", "SPM", "WLF")

# Danish overseas territories: Faroe Islands, Greenland
danish_territories <- c("FRO", "GRL")

# British overseas territories: Anguilla, Ascension island, Bermuda, Cayman Islands, Falkland Islands, Guernsey, Gibraltar, British Indian Ocean Territories, Jersey, Monserratt, Pitcairn Island, South Georgia and the South Sandwich Islands, Saint Helena/Ascension/Tristan da Cunha, Tristan da Cunha, Turks and Caicos Islands, British Virgin Islands
uk_territories <- c("AIA","ASC","BMU","CYM","FLK","GGY","GIB","IOT","JEY","MSR","PCN","SGS","SHN","TAA","TCA","VGB")

eu_territories <- c(dutch_territories, french_territories, danish_territories, uk_territories)

# Norwegian overseas territories: Bouvet Islands, Svalbard and Jan Mayen Islands
norwegian_territories <- c("BVT", "SJM")

# US overseas territories:  American Samoa, Guam, Northern Marianas Islands, Puerto Rico, US Virgin Islands
us_territories <- c("ASM", "GUM", "MNP", "PRI", "VIR")

eu_northern_agreement <- c("NOR", "ISL")
```

# Apply Definitions

## Country Development Status

We use the flag of the vessel to assign development status. If the flag of the vessel was not able to be determined, we assume the development status to be "Developing". 

```{r}
# Read in country list with development status
country_list <- read_csv(here::here("data", "country-conversion-sheet-all.csv"))

country_development_status <- country_list %>%
  group_by(iso3) %>%
  summarize(development_status_full = unique(development_status)) %>%
  mutate(development_status = str_replace(development_status_full, ' \\(.*\\)', ""),
         development_status_notes = str_extract(development_status_full, '\\(.*\\)')) %>%
  dplyr::select(iso3, development_status)

country_development_status$development_status[country_development_status$iso3 == "ATF"] <- "Developed"
country_development_status$development_status[country_development_status$iso3 == "IOT"] <- "Developed"

# Add development status to the vessel list
temp_vessel_list <- vessel_list %>%
  left_join(country_development_status, by = c("flag" = "iso3")) 

# Let's also add identifies of EU vessels and US territory vessels to the vessel list
temp_vessel_list <- temp_vessel_list %>%
  mutate(is_EU = case_when(flag %in% eu_countries ~ T,
                           TRUE ~ F),
         is_EU_territory = case_when(flag %in% eu_territories ~ T,
                                     TRUE ~ F),
         is_US_territory = case_when(flag %in% us_territories ~ T,
                                     TRUE ~ F))
```

## Distant water fishing 

In order to determine whether a vessel is engaging in distant water fishing, we need to know something about the sovereign state of the vessel's flag state. 

```{r}
# Get pairings of administering and sovereign states from the EEZ data
sovereign_pairings <- temp_vessel_list %>%
  distinct(territory1_iso3, sovereign1_iso3) %>%
  rename(flag = territory1_iso3, flag_sovereign = sovereign1_iso3)
sovereign_pairings$flag_sovereign[sovereign_pairings$flag == "CHN"] <- "CHN"

# Create a manual list of missing sovereign pairings
sovereign_pairings_manual <- tibble(flag = c("HKG", "KHM", "CUW", "BLZ", "CYM", "JOR", "PSE", "JAM", "AIA")) %>%
  mutate(flag_sovereign = case_when(flag == "HKG" ~ "CHN",
                                    flag == "CUW" ~ "NLD",
                                    flag == "CYM" ~ "GBR",
                                    flag == "PSE" ~ "ISR",
                                    flag == "AIA" ~ "GBR",
                                    TRUE ~ flag))

sovereign_pairings <- sovereign_pairings %>%
  bind_rows(sovereign_pairings_manual) %>%
  distinct(flag, flag_sovereign)

# Also fix that on the vessel list
temp_vessel_list$sovereign1_iso3[temp_vessel_list$territory1_iso3 == "CHN"] <- "CHN"

# We then match it back to our vessel list so each entry has an assigned sovereign flag
temp_vessel_list <- temp_vessel_list %>%
  left_join(sovereign_pairings, by = "flag")

# We fist exclude entries where the flag state of the vessel and the administering state of the EEZ in which it is fishing are the same
distant_water_fishing <- temp_vessel_list %>%
  mutate(territory1_match = case_when(!is.na(territory1_iso3) & flag == territory1_iso3 ~ T,
                                      TRUE ~ F),
         territory2_match = case_when(!is.na(territory2_iso3) & flag == territory2_iso3 ~ T,
                                      TRUE ~ F),
         territory3_match = case_when(!is.na(territory3_iso3) & flag == territory3_iso3 ~ T,
                                      TRUE ~ F)) %>%
  dplyr::filter(!territory1_match & !territory2_match & !territory3_match)
```

### "Intra-EU fishing".

Vessels flagged to EU member states have the right to fish in the EEZs of other EU member states, therefore we do not include these instances as "distant water fishing". In order to remove these from our dataset, we first need create a list of EU member states, as well as non-member states with with the EU has fishing agreements as part of the northern agreement (i.e. Norway and Iceland). 

We define "intra-EU fishing" as fishing activity that meets one of the following criteria: 
1. The flag state of the vessel is a member state of the EU, Norway, Svalbard and Jan Mayen, or Iceland and the EEZ in which it is fishing is administered by a member state of the EU, Norway, Svalbard and Jan Mayen, or Iceland (e.g. a French-flagged vessel fishing in the EEZ of Spain);
2. The sovereign of the vessel's flag state is a member state of the EU, Norway, Svalbard and Jan Mayen, or Iceland and the EEZ in which it is fishing is administered by a member state of the EU, Norway, Svalbard and Jan Mayen, or Iceland (e.g. a XXX-flagged vessel fishing in the EEZ of Spain).

We do not consider the following to be "intra-EU fishing": 
1. The flag state of the vessel is a member state of the EU, Norway, Svalbard and Jan Mayen, or Iceland and the EEZ in which it is fishing belongs to a territory or distant region of an EU member state (e.g. a French-flagged vessel fishing in the EEZ of French Polynesia). 

```{r}
# Exclude intra EU fishing
distant_water_fishing <- distant_water_fishing %>%
  mutate(is_intra_EU = case_when(flag %in% c(eu_countries, eu_northern_agreement, norwegian_territories) & territory1_iso3 %in% c(eu_countries, eu_northern_agreement, norwegian_territories) ~ T,
                                 flag_sovereign %in% c(eu_countries, eu_northern_agreement, norwegian_territories) & territory1_iso3 %in% c(eu_countries, eu_northern_agreement, norwegian_territories) ~ T,
                                 TRUE ~ F)) %>%
  dplyr::filter(!is_intra_EU) %>%
  mutate(distant_water = T) %>%
  dplyr::select(eez_id, ssvid, fao_region, distant_water)
```

### Sovereignity

If the sovereign flag state of a vessel is the same as the sovereign state of the EEZ in which it's fishing, this connection may still be considered to be distant water fishing (e.g. US vessel fishing in Palmyra Atoll), though this is generally not considered to be foreign distant water fishing.

We descibe "sovereign fishing" as fishing activity that meets one of the following criteria: 
1. The flag state of the vessel is the same as the sovereign of the administering territory of the EEZ in which it is fishing (e.g. a US flagged vessel fishing in the EEZ of Palmyra Atoll).
2. The sovereign of the flag state of the vessel is the same as the sovereign of the administering territory of the EEZ in which it is fishing (e.g. a Puerto-Rican flagged vessel fishing in the EEZ of Palmyra Atoll);

Sovereign fishing is included in our definition of distant water fishing

```{r}
temp_vessel_list <- temp_vessel_list %>%
  left_join(distant_water_fishing, by = c("eez_id", "ssvid", "fao_region"))
temp_vessel_list$distant_water[is.na(temp_vessel_list$distant_water)] <- F

```

## High seas fishing

In order to later be able to easily identify high seas fishing, we want to be able to easily identify the fraction of each vessel's total fishing effort spent on the high seas in a given year. 

```{r}
# Get totals by vessel
vessel_totals_high_seas <- temp_vessel_list %>%
  dplyr::filter(eez_id == 0) %>%
  group_by(ssvid) %>%
  summarize(fishing_h_hs = sum(fishing_hours_eez_fao, na.rm = T),
            fishing_KWh_hs = sum(fishing_KWh_eez_fao, na.rm = T))

vessel_totals_prop_hs <- temp_vessel_list %>%
  group_by(ssvid) %>%
  summarize(fishing_h = sum(fishing_hours_eez_fao, na.rm = T),
            fishing_KWh = sum(fishing_KWh_eez_fao, na.rm = T)) %>%
  ungroup() %>%
  left_join(vessel_totals_high_seas, by = "ssvid") %>%
  mutate(prop_fishing_hours_HS = case_when(is.na(fishing_h_hs) ~ 0, 
                                           TRUE ~ fishing_h_hs/fishing_h),
         prop_fishing_KWh_HS = case_when(is.na(fishing_KWh_hs) ~ 0, 
                                         TRUE ~ fishing_KWh_hs/fishing_KWh)) %>%
  dplyr::select(ssvid, prop_fishing_hours_HS, prop_fishing_KWh_HS)


temp_vessel_list <- temp_vessel_list %>%
  left_join(vessel_totals_prop_hs, by = "ssvid")
```

## IUU

### IUU #1: RFMO IUU vessel lists

Using the combined list of IUU vessels (https://iuu-vessels.org/), we want to try to match as many vessels as possible to our vessel list. 

```{r}
# Read in IUU list
iuu_list <- read_csv(iuu_dat_path) %>%
  clean_names(case = "snake")

# Extract only vessels currently listed, and create a new entry for each using the "name" field
iuu_clean_name <- iuu_list %>% 
   dplyr::filter(currently_listed) %>%
   mutate(name_new = str_split(name, ", "))%>%
   unnest(cols = c(name_new)) %>%
  dplyr::select(name, name_new, imo, gear_type, flag, ircs, ssvid, gt, length) %>%
  mutate(n_shipname = map_chr(name_new, normalize_shipname))
  
# Do the same thing, but for RFMO name since they differ
iuu_clean_rfmo_name <- iuu_list %>% 
   dplyr::filter(currently_listed) %>%
   mutate(name_new1 = str_split(rfmo_name, ", "),
          name_new2 = str_split(rfmo_name, "[()]"),
          name_new = case_when(name_new1 != rfmo_name ~ name_new1,
                               TRUE ~ name_new2)) %>%
   unnest(cols = c(name_new)) %>%
  dplyr::select(name, name_new, imo, gear_type, flag, ircs, ssvid, gt, length) %>%
  mutate(n_shipname = map_chr(name_new, normalize_shipname))

### Blank database for IUU vessels
iuu_matching_vessels <- tibble(ssvid = integer(0),
                               flag = character(0),
                               broadcast_shipname = character(0))

### Abbreviated vessel list for matching
vessels_for_matching <- temp_vessel_list %>%
  distinct(ssvid, flag, vessel_class, length_m, tonnage_gt, engine_power_kw, broadcast_shipname, broadcast_callsign, broadcast_imo)

iuu <- iuu_clean_name %>%
  dplyr::select(-name, -name_new) %>%
  rename(iuu_imo = imo, iuu_gear_type = gear_type, iuu_flag = flag, iuu_callsign = ircs, iuu_ssvid = ssvid, iuu_tonnage_gt = gt, iuu_length = length, iuu_shipname = n_shipname)

iuu2 <- iuu_clean_rfmo_name %>%
  dplyr::select(-name, -name_new) %>%
  rename(iuu_imo = imo, iuu_gear_type = gear_type, iuu_flag = flag, iuu_callsign = ircs, iuu_ssvid = ssvid, iuu_tonnage_gt = gt, iuu_length = length, iuu_shipname = n_shipname)

### Get matches by ssvid
# Join by id number - 4 matching vessels, all appear to be a match
iuu_by_ssvid <- vessels_for_matching %>%
    inner_join(iuu, by = c("ssvid"="iuu_ssvid"))

iuu_matching_vessels <- iuu_matching_vessels %>%
  bind_rows(iuu_by_ssvid %>% distinct(ssvid, flag, broadcast_shipname))

### Get matches by call sign - 3 matching vessels, only two appear to be a match
iuu_by_callsign <- vessels_for_matching %>%
    inner_join(iuu %>% dplyr::filter(!is.na(iuu_callsign)), by = c("broadcast_callsign"="iuu_callsign"))

iuu_matching_vessels <- iuu_matching_vessels %>%
  bind_rows(iuu_by_callsign %>% distinct(ssvid, flag, broadcast_shipname) %>% dplyr::filter(broadcast_shipname != "ROSE4"))

### Get matches by IMO - 3 matching vessels, all appear to be enough for a match
iuu_by_imo <- vessels_for_matching %>%
    inner_join(iuu %>% dplyr::filter(!is.na(iuu_imo)), by = c("broadcast_imo"="iuu_imo"))

iuu_matching_vessels <- iuu_matching_vessels %>%
  bind_rows(iuu_by_imo %>% distinct(ssvid, flag, broadcast_shipname))

### Match by normalized shipname  - 52 matching records, most are not a match. 
iuu_by_name1 <- vessels_for_matching %>%
    inner_join(iuu %>% dplyr::filter(!is.na(iuu_shipname)), by = c("broadcast_shipname"="iuu_shipname")) %>%
  arrange(broadcast_shipname)

iuu_by_name2 <- vessels_for_matching %>%
    inner_join(iuu2 %>% dplyr::filter(!is.na(iuu_shipname)), by = c("broadcast_shipname"="iuu_shipname")) %>%
  arrange(broadcast_shipname)

# Manually determined matches
name_matches1 <- iuu_by_name1 %>%
  dplyr::filter(broadcast_shipname %in% c("EPHRAEEM", "HUALI8", "SHUNCHANG3"))

name_matches2 <- iuu_by_name2 %>%
  dplyr::filter(broadcast_shipname %in% c("HAILUNG", "HUALI8", "MYSMARII"))

iuu_matching_vessels <- iuu_matching_vessels %>%
  bind_rows(name_matches1 %>% distinct(ssvid, flag, broadcast_shipname)) %>%
  bind_rows(name_matches2 %>% distinct(ssvid, flag, broadcast_shipname))

# Get all matches - 7 vessels
iuu_matches <- iuu_matching_vessels %>%
  distinct(ssvid)

# Apply to vessel list
temp_vessel_list <- temp_vessel_list %>%
  mutate(iuu1 = ifelse(ssvid %in% iuu_matches$ssvid, T, F))
                    
```

## Overfished and Unassessed Stocks

### OA #1: Overfished as determined by the RAM legacy stock assessment database

```{r}
# Load costello data to get the fraction of catches by eez/fao region that are in RAM and are determined to be overfished
costello_2016_dat <- read_csv(costello_2016_path) %>%
  clean_names(case = "snake")

costello_2016_dat_clean <- costello_2016_dat %>%
  mutate(region_fao_chr = as.character(region_fao),
         n_regions = nchar(region_fao_chr)/2,
         region_fao_split = str_split(gsub("(.{2})", "\\1 ", region_fao_chr), " ")) %>%
  unnest(cols = c(region_fao_split)) %>%
  mutate(region_fao_split = as.numeric(region_fao_split)) %>%
  dplyr::filter(region_fao_split != "") %>%
  mutate(iso3 = case_when(country == "Channel Islands" ~ "JEY",
                          country == "Micronesia" ~ "FSM",
                          country == "Zanzibar" ~ "TZA",
                          TRUE ~ countrycode(country, "country.name", "iso3c")))

# Get EEZ regions for matching
eez_regions <- temp_vessel_list %>%
  distinct(eez_id, fao_region, territory1_iso3, territory2_iso3, territory3_iso3, sovereign1_iso3, sovereign2_iso3, sovereign3_iso3)

# Get RAM stocks only and summarize by iso3 and fao_region
ram_data <- costello_2016_dat_clean %>%
  dplyr::filter(dbase == "RAM") %>%
  group_by(iso3, region_fao_split) %>%
  summarize(n_stocks = n_distinct(id_orig),
            mean_bv_bmsy = mean(bv_bmsy),
            median_bv_bmsy = median(bv_bmsy)) %>%
  mutate(oa_mean = ifelse(mean_bv_bmsy >= 1, F, T),
         oa_med = ifelse(median_bv_bmsy >= 1, F, T),
         oa1 = ifelse(oa_mean & oa_med, T, F))

ram_by_eez_region <- eez_regions %>%
  left_join(ram_data, by = c("territory1_iso3" = "iso3", "fao_region" = "region_fao_split")) %>%
  arrange(eez_id, fao_region) %>%
  dplyr::select(eez_id, fao_region, oa1)
ram_by_eez_region$oa1[is.na(ram_by_eez_region$oa1)] <- F

# Join back to vessel list
temp_vessel_list <- temp_vessel_list %>%
  left_join(ram_by_eez_region, by = c("eez_id", "fao_region"))
```

### OA #2: Overfished as determined by Costello et al. (2016)

```{r}
# Include all stocks 
all_data <- costello_2016_dat_clean %>%
  group_by(iso3, region_fao_split) %>%
  summarize(n_stocks = n_distinct(id_orig),
            mean_bv_bmsy = mean(bv_bmsy),
            median_bv_bmsy = median(bv_bmsy)) %>%
  mutate(oa_mean = ifelse(mean_bv_bmsy >= 1, F, T),
         oa_med = ifelse(median_bv_bmsy >= 1, F, T),
         oa2 = ifelse(oa_mean & oa_med, T, F))

all_by_eez_region <- eez_regions %>%
  left_join(all_data, by = c("territory1_iso3" = "iso3", "fao_region" = "region_fao_split")) %>%
  arrange(eez_id, fao_region) %>%
  dplyr::select(eez_id, fao_region, oa2)
all_by_eez_region$oa2[is.na(all_by_eez_region$oa2)] <- F

# Join back to vessel list
temp_vessel_list <- temp_vessel_list %>%
  left_join(all_by_eez_region, by = c("eez_id", "fao_region"))
```


# Export final vessel list

```{r}
# Export final vessel list with definitions
write_csv(temp_vessel_list, paste0(results_dir, "vessel-list-2018-final.csv"))
write_csv(temp_vessel_list, paste0(app_dir, "vessel-list-2018-final.csv"))
```

