---
output:
  html_document: default

title: "SubsidyExplorer - Step 6: Run Model"
author: "Kat Millage, Vienna Saccomanno, Laura Lea Rubino, Christopher Costello"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 11pt
bibliography: "../pew-subsidies.bib"
---

# Introduction 

This script generates the most ambitious global and regional results obtained by removing all capacity enhancing subsidies from all WTO Members and Observers.

```{r setup, include=FALSE}
# Load packages
library(knitr) 
library(tidyverse)

knitr::opts_chunk$set(echo = TRUE)

make_plots <- T

if(make_plots){
  library(RColorBrewer)
  library(scales)
}

# Directories for the output files generated by this script
results_dir <- here::here("results", "07-sensitivity-analysis/")
if (dir.exists(results_dir) == F) {
  dir.create(results_dir, recursive = T)
}
```

```{r}
# Source model script
source(here::here("app", "scripts", "BioEconModel.R"))

# Source plotting script
source(here::here("scripts", "functions", "BioEconomicModelPlots.R"))
```

```{r}
# Load vessel list
vessel_dat <- read.csv(here::here("app", "data", "vessel_list_2018_final.csv"), stringsAsFactors = F)

# Create high seas code
vessel_dat <- vessel_dat %>%
  mutate(eez_hs_code = case_when(eez_id == 0 ~ paste0("HS-", fao_region),
                                 TRUE ~ as.character(eez_id)))

# Load country dependencies helper file
country_dependencies <- read_csv(here::here("data", "lookup-tables", "country_dependencies.csv"))

# Vector of all WTO Members and Observers for use in the app [does not include the overseas territories associated with them]
wto_members_and_observers <- country_dependencies$iso3[country_dependencies$is_WTO & !country_dependencies$is_overseas_territory]
```

```{r}
# Load biological parameters for the model
bio_dat_regional <- read.csv(here::here("app", "data", "model_parameters_regional_3_regions.csv"))

# Regional parameter list
bio_dat_regional_list <- bio_dat_regional %>%
  gather(region, value, -c(1:2)) %>%
  group_by(region) %>%
  group_split()
```

```{r}
# Threshold to be considered managed (using FMI scores)
managed_cutoff <- 0.66
```

```{r}
# Proposal settings
proposal_settings <- read.csv(here::here("app", "data", "wto_proposal_settings.csv"), stringsAsFactors = F)

# Proposal names
included_proposals <- proposal_settings %>%
  dplyr::filter(include == "Yes") %>%
  mutate(display_name = case_when(proposal == "Default" ~ "None",
                                  TRUE ~ paste0(title_tool, " (", proposal, ")"))) %>%
  dplyr::select(category, proposal, display_name) %>%
  arrange(category)

proposal_choices <- included_proposals$proposal
names(proposal_choices) <- included_proposals$display_name
```

```{r}
# Cap/Tier Data
cap_tier_dat <- read_csv(here::here("app", "data", "USA_cap_tier_tidy.csv")) %>%
  arrange(iso3)

# Data
# 1) Subsidy estimates (Sumaila et al. 2019) ---
subsidy_dat_sumaila_raw <- read_csv("./data/sumaila_et_al_2019_subsidies_tidy.csv") %>%
  arrange(iso3)

# Organize subsidy types as defined by Sumaila et al. (2019) for consistent plotting throughout
subsidy_classification_sumaila <- subsidy_dat_sumaila_raw %>%
  distinct(category, category_name, type, type_name) %>%
  arrange(type)

subsidy_types_sorted_sumaila <- subsidy_classification_sumaila$type
names(subsidy_types_sorted_sumaila) <- subsidy_classification_sumaila$type_name


```

## Model proposals

```{r}
proposal_results <- NULL
i <- 1
for(i in 1:length(proposal_choices)){
  
  # Choose proposal
  proposal <- proposal_choices[i]
  
  # Get all data for that proposal
  selected_proposal <- included_proposals %>%
      dplyr::filter(proposal == proposal)
  
  # Get all IUU conditions
  iuu <- 
    list("definitions" = unlist(str_split(selected_proposal$iuu_definitions, ", ")),
         "assumption" = selected_proposal$iuu_assumption,
         "percent" = selected_proposal$iuu_percent,
         "scope" = selected_proposal$iuu_scope,
         "scope_select" = unlist(str_split(selected_proposal$iuu_scope_select, ", ")),
         "scope_manual" = unlist(str_split(selected_proposal$iuu_scope_manual, ", ")),
         "allow_sdt" = selected_proposal$iuu_allow_sdt,
         "sdt_ldc" = selected_proposal$iuu_sdt_ldc,
         "sdt_what_ldc" = unlist(str_split(selected_proposal$iuu_sdt_what_ldc, ", ")),
         "sdt_time_delay_ldc" = selected_proposal$iuu_sdt_time_delay_ldc,
         "sdt_developing" = selected_proposal$iuu_sdt_developing,
         "sdt_what_developing" = unlist(str_split(selected_proposal$iuu_sdt_what_developing, ", ")),
         "sdt_time_delay_developing" = selected_proposal$iuu_sdt_time_delay_developing,
         "sdt_sve" = selected_proposal$iuu_sdt_sve,
         "sdt_what_sve" = unlist(str_split(selected_proposal$iuu_sdt_what_sve, ", ")),
         "sdt_time_delay_sve" = selected_proposal$iuu_sdt_time_delay_sve)
  
   # Get all OA conditions
   oa <- 
     list("definitions" = unlist(str_split(selected_proposal$oa_definitions, ", ")),
          "scope" = selected_proposal$oa_scope,
          "scope_select" = unlist(str_split(selected_proposal$oa_scope_select, ", ")),
          "scope_manual" = unlist(str_split(selected_proposal$oa_scope_manual, ", ")),
          "hs_cutoff" = selected_proposal$oa_hs_cutoff,
          "length_cutoff" = selected_proposal$oa_length_cutoff,
          "tonnage_cutoff" = selected_proposal$oa_tonnage_cutoff,
          "engine_cutoff" = selected_proposal$oa_engine_cutoff,
          "allow_sdt" = selected_proposal$oa_allow_sdt,
          "sdt_ldc" = selected_proposal$oa_sdt_ldc,
          "sdt_what_ldc" = unlist(str_split(selected_proposal$oa_sdt_what_ldc, ", ")),
          "sdt_hs_cutoff_ldc" = selected_proposal$oa_sdt_hs_cutoff_ldc,
          "sdt_time_delay_ldc" = selected_proposal$oa_sdt_time_delay_ldc,
          "sdt_developing" = selected_proposal$oa_sdt_developing,
          "sdt_what_developing" = unlist(str_split(selected_proposal$oa_sdt_what_developing, ", ")),
          "sdt_hs_cutoff_developing" = selected_proposal$oa_sdt_hs_cutoff_developing,
          "sdt_time_delay_developing" = selected_proposal$oa_sdt_time_delay_developing,
          "sdt_sve" = selected_proposal$oa_sdt_sve,
          "sdt_what_sve" = unlist(str_split(selected_proposal$oa_sdt_what_sve, ", ")),
          "sdt_hs_cutoff_sve" = selected_proposal$oa_sdt_hs_cutoff_sve,
          "sdt_time_delay_sve" = selected_proposal$oa_sdt_time_delay_sve)
   
   # Get all Overcap conditions
   overcap <- 
     list("definitions" = unlist(str_split(selected_proposal$overcap_definitions, ", ")),
          "scope" = selected_proposal$overcap_scope,
          "scope_select" = unlist(str_split(selected_proposal$overcap_scope_select, ", ")),
          "scope_manual" = unlist(str_split(selected_proposal$overcap_scope_manual, ", ")),
          "hs_cutoff" = selected_proposal$overcap_hs_cutoff,
          "length_cutoff" = selected_proposal$overcap_length_cutoff,
          "tonnage_cutoff" = selected_proposal$overcap_tonnage_cutoff,
          "engine_cutoff" = selected_proposal$overcap_engine_cutoff,
          "allow_sdt" = selected_proposal$overcap_allow_sdt,
          "sdt_ldc" = selected_proposal$overcap_sdt_ldc,
          "sdt_what_ldc" = unlist(str_split(selected_proposal$overcap_sdt_what_ldc, ", ")),
          "sdt_hs_cutoff_ldc" = selected_proposal$overcap_sdt_hs_cutoff_ldc,
          "sdt_time_delay_ldc" = selected_proposal$overcap_sdt_time_delay_ldc,
          "sdt_developing" = selected_proposal$overcap_sdt_developing,
          "sdt_what_developing" = unlist(str_split(selected_proposal$overcap_sdt_what_developing, ", ")),
          "sdt_hs_cutoff_developing" = selected_proposal$overcap_sdt_hs_cutoff_developing,
          "sdt_time_delay_developing" = selected_proposal$overcap_sdt_time_delay_developing,
          "sdt_sve" = selected_proposal$overcap_sdt_sve,
          "sdt_what_sve" = unlist(str_split(selected_proposal$overcap_sdt_what_sve, ", ")),
          "sdt_hs_cutoff_sve" = selected_proposal$overcap_sdt_hs_cutoff_sve,
          "sdt_time_delay_sve" = selected_proposal$overcap_sdt_time_delay_sve)
   
   # Get all Cap/Tier conditions
   cap_tier = 
     list("on_off" = selected_proposal$cap_on_off,
          "subsidy_types" = unlist(str_split(selected_proposal$cap_subsidy_types, ", ")),
          "tier_number" = selected_proposal$cap_tier_number,
          "tier_system" = selected_proposal$tier_system,
          "two_tier_cutoff" = selected_proposal$two_tier_cutoff,
          "three_tier_cutoff" = as.numeric(unlist(str_split(
          selected_proposal$three_tier_cutoff, ", "
          ))),
          "tier1_cap_rule" = selected_proposal$tier1_cap_rule,
          "tier2_cap_rule" = selected_proposal$tier2_cap_rule,
          "tier3_cap_rule" = selected_proposal$tier3_cap_rule,
          "tier1_cap_value" = selected_proposal$tier1_cap_value,
          "tier1_cap_fishers" = selected_proposal$tier1_cap_fishers,
          "tier1_cap_percent" = selected_proposal$tier1_cap_percent,
          "tier2_cap_value" = selected_proposal$tier2_cap_value,
          "tier2_cap_fishers" = selected_proposal$tier1_cap_fishers,
          "tier2_cap_percent" = selected_proposal$tier2_cap_percent,
          "tier3_cap_value" = selected_proposal$tier3_cap_value,
          "tier3_cap_fishers" = selected_proposal$tier3_cap_fishers,
          "tier3_cap_percent" = selected_proposal$tier3_cap_percent)
   
   ### Find fleets
    fleet <-  CreateFleets(
      vessel_list = vessel_dat,
      iuu = iuu,
      oa = oa,
      overcap = overcap,
      cap_tier = cap_tier,
      cap_tier_dat = cap_tier_dat,
      profile_dat = combined_fishery_stats_dat,
      managed_threshold = managed_cutoff,
      wto_members_and_observers = wto_members_and_observers,
      subsidy_types_all = subsidy_types_sorted_sumaila,
      flag_summary_dat = flag_summary)
    
    # Make list
    fleet_list <- fleet$summary %>%
      group_by(region) %>%
      group_split()
    names(fleet_list) <- colnames(bio_dat)[-c(1:2)]
  
}
```



